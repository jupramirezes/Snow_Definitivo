<!DOCTYPE html>
<html lang="es">
<head>
  <script src="./config.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Control Bar ¬∑ PWA (Supabase)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./styles/main.css">
  <!-- Librer√≠as para exportaci√≥n -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="./export-utils.js?v=7"></script>
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "{{SUPABASE_URL}}";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "{{SUPABASE_ANON_KEY}}";
  </script>
</head>
<body>
<div class="app">
  <header class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="m-0">Control Bar ¬∑ PWA</h4>
    <div class="d-flex align-items-center gap-2">
      <label class="form-label m-0">Fecha</label>
      <input id="appDate" type="date" class="form-control form-control-sm" style="min-width:150px">
      <button id="btnReset" class="btn btn-sm btn-outline-secondary">Reset local</button>
      <button id="btnResetData" class="btn btn-sm btn-outline-danger" onclick="resetAllDataConfirm()">üóëÔ∏è Reset BD</button>
      <button id="btnExportData" class="btn btn-sm btn-outline-success" onclick="exportDailyData()">üìä Export</button>
    </div>
  </header>

  <section id="home" class="tile">
    <!-- Dashboard de KPIs -->
    <div id="dashboardKPIs" class="row g-2 mb-3"></div>
    
    <div class="row g-2">
      <div class="col-12 col-md-3"><button class="w-100 btn btn-dark btn-fat" data-goto="mesero">Mesero ¬∑ Venta r√°pida</button></div>
      <div class="col-12 col-md-3"><button class="w-100 btn btn-dark btn-fat" data-goto="pos">Barra/Granizados ¬∑ Inventario + Compras + Gastos</button></div>
      <div class="col-12 col-md-3"><button class="w-100 btn btn-dark btn-fat" data-goto="socios">Socios ¬∑ Cierres + Reparto</button></div>
      <div class="col-12 col-md-3"><button class="w-100 btn btn-warning btn-fat" data-goto="admin">‚öôÔ∏è Administraci√≥n</button></div>
    </div>
  </section>

  <!-- Mesero: Venta r√°pida -->
  <section id="mesero" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Ventas (Mesero)</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-6">
        <label class="form-label">POS</label>
        <select id="ventaPOS" class="form-select form-select-lg"><option>Barra</option><option>Granizados</option></select>
      </div>
      <div class="col-6">
        <label class="form-label">Producto</label>
        <select id="ventaProd" class="form-select form-select-lg"></select>
      </div>
      <div class="col-4">
        <label class="form-label">Cant.</label>
        <input id="ventaCant" type="number" min="1" value="1" class="form-control form-control-lg">
      </div>
      <div class="col-4">
        <label class="form-label">Pago</label>
        <select id="ventaPago" class="form-select form-select-lg">
          <option>Efectivo</option>
          <option>Transferencia</option>
          <option>Mixto</option>
        </select>
      </div>
      <div class="col-4">
        <label class="form-label">Notas</label>
        <input id="ventaNotas" class="form-control form-control-lg" placeholder="Mesa/promo">
      </div>

      <!-- Campos para pago Mixto -->
      <div id="mixtoFields" class="col-12 mixto-fields">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Efectivo ($)</label>
            <input id="ventaEfectivo" type="number" min="0" value="0" class="form-control form-control-lg">
          </div>
          <div class="col-6">
            <label class="form-label">Transferencia ($)</label>
            <input id="ventaTransferencia" type="number" min="0" value="0" class="form-control form-control-lg">
          </div>
          <div class="col-12">
            <small class="text-muted">Total a pagar: <span id="totalAPagar">$0</span></small>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="muted-hint">Los <b>descuentos a socios</b> reg√≠stralos en POS ‚Üí Gastos (tipo <i>DescuentoSocio</i>). El <b>descuadre</b> se calcula en el cierre diario con efectivo contado.</div>
      </div>

      <div class="col-12 d-grid">
        <button id="btnAddVenta" class="btn btn-success btn-fat mt-2">Agregar venta</button>
        <div id="saleValidationErrors" class="mt-2 text-danger small" style="display:none"></div>
      </div>
      
      <!-- Actividad reciente -->
      <div class="col-12">
        <div class="tile mt-3">
          <h6>üìã Actividad del d√≠a</h6>
          <div id="activityLog" class="small"></div>
        </div>
      </div>
    </div>
    <div class="table-responsive mt-3">
      <table class="table table-sm" id="tblVentas">
        <thead>
          <tr>
            <th>Fecha</th><th>Hora</th><th>POS</th><th>Producto</th><th>Cant</th><th>Pago</th><th>Total</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- POS -->
  <section id="pos" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Inventario ¬∑ Compras ¬∑ Gastos</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-12 col-lg-6 tile">
        <h6>Inventario del d√≠a</h6>
        <div class="row g-2">
          <div class="col-6"><label class="form-label">POS</label><select id="invPOS" class="form-select"><option>Barra</option><option>Granizados</option></select></div>
          <div class="col-6 d-grid"><button id="btnCargarConteo" class="btn btn-outline-dark mt-4">Cargar inventario</button></div>
          <div class="col-12"><div id="inventarioContainer"></div></div>
          <div class="col-12 d-grid"><button id="btnGuardarInventario" class="btn btn-dark">Guardar cambios inventario</button></div>
          
          <!-- Mostrar compras del d√≠a -->
          <div class="col-12 mt-3">
            <h6>üì¶ Compras del d√≠a</h6>
            <div id="comprasDelDia"></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Compras</h6>
          <div class="row g-2">
            <div class="col-6"><label class="form-label">Producto</label><select id="compraProd" class="form-select"></select></div>
            <div class="col-3"><label class="form-label">Cant</label><input id="compraCant" type="number" min="1" value="1" class="form-control"/></div>
            <div class="col-3"><label class="form-label">PU</label><input id="compraPU" type="number" min="0" value="0" class="form-control"/></div>
            <div class="col-12"><label class="form-label">Factura (foto)</label><input id="compraFile" type="file" accept="image/*" class="form-control"/></div>
            <div class="col-12"><input id="compraNotas" class="form-control" placeholder="Notas"/></div>
            <div class="col-12 d-grid"><button id="btnAddCompra" class="btn btn-primary">Agregar compra</button></div>
          </div>
        </div>
        
        <div class="tile mt-3">
          <h6>Gastos y N√≥mina</h6>
          <div class="row g-2">
            <div class="col-4"><select id="gastoTipo" class="form-select"><option value="Gasto">Gasto</option><option value="Nomina">N√≥mina</option><option value="DescuentoSocio">DescuentoSocio</option></select></div>
            <div class="col-4"><input id="gastoConcepto" class="form-control" placeholder="Concepto"/></div>
            <div class="col-4"><input id="gastoValor" type="number" min="0" class="form-control" placeholder="Valor"/></div>
            <div class="col-6">
              <input id="gastoAtrib" class="form-control" placeholder="Socio/Persona"/>
              <select id="gastoSocioSelect" class="form-select" style="display:none">
                <option value="">Seleccionar socio...</option>
              </select>
            </div>
            <div class="col-6"><input id="gastoNotas" class="form-control" placeholder="Notas"/></div>
            <div class="col-12 d-grid"><button id="btnAddGasto" class="btn btn-warning">Agregar gasto</button></div>
          </div>
          
          <!-- Mostrar gastos del d√≠a -->
          <div class="col-12 mt-3">
            <h6>üí∏ Gastos del d√≠a</h6>
            <div id="gastosDelDia"></div>
          </div>
          
          <!-- Secci√≥n de n√≥mina del d√≠a -->
          <div class="mt-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
            <h6>N√≥mina r√°pida del d√≠a</h6>
            <div class="row g-2">
              <div class="col-12">
                <button id="btnCargarEmpleados" class="btn btn-sm btn-outline-primary">Cargar empleados</button>
                <button id="btnPagarNomina" class="btn btn-sm btn-success" style="display:none">Registrar n√≥mina del d√≠a</button>
              </div>
              <div class="col-12">
                <div id="nominaContainer"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Administraci√≥n -->
  <section id="admin" class="tile mt-3 admin-section" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">‚öôÔ∏è Administraci√≥n</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    
    <div class="row g-3 mt-2">
      <!-- Gesti√≥n de Productos -->
      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Gesti√≥n de Productos</h6>
          <div class="row g-2 mb-3">
            <div class="col-6"><input id="prodSKU" class="form-control form-control-sm" placeholder="SKU (ej: BAR-001)"/></div>
            <div class="col-6"><input id="prodName" class="form-control form-control-sm" placeholder="Nombre producto"/></div>
            <div class="col-4"><input id="prodPrice" type="number" class="form-control form-control-sm" placeholder="Precio"/></div>
            <div class="col-4"><select id="prodPOS" class="form-select form-select-sm"><option>Barra</option><option>Granizados</option></select></div>
            <div class="col-4"><input id="prodVasos" type="number" min="0" value="0" class="form-control form-control-sm" placeholder="Vasos"/></div>
            <div class="col-12 d-grid"><button id="btnAddProduct" class="btn btn-primary btn-sm">Agregar Producto</button></div>
          </div>
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm" id="tblProducts">
              <thead class="sticky-top bg-white">
                <tr><th>SKU</th><th>Nombre</th><th>Precio</th><th>POS</th><th>Vasos</th><th>Acciones</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Gesti√≥n de Empleados -->
      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Gesti√≥n de Empleados</h6>
          <div class="row g-2 mb-3">
            <div class="col-6"><input id="empName" class="form-control form-control-sm" placeholder="Nombre completo"/></div>
            <div class="col-6"><input id="empRole" class="form-control form-control-sm" placeholder="Cargo"/></div>
            <div class="col-12"><input id="empSalary" type="number" class="form-control form-control-sm" placeholder="Salario diario"/></div>
            <div class="col-12 d-grid"><button id="btnAddEmployee" class="btn btn-success btn-sm">Agregar Empleado</button></div>
          </div>
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm" id="tblEmployees">
              <thead class="sticky-top bg-white">
                <tr><th>Nombre</th><th>Cargo</th><th>Salario/d√≠a</th><th>Estado</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Gesti√≥n de Socios -->
      <div class="col-12">
        <div class="tile">
          <h6>Gesti√≥n de Socios y Porcentajes</h6>
          <div class="row g-2 mb-3">
            <div class="col-md-4"><input id="partnerName" class="form-control form-control-sm" placeholder="Nombre del socio"/></div>
            <div class="col-md-4"><input id="partnerShare" type="number" min="0" max="100" step="0.1" class="form-control form-control-sm" placeholder="% Participaci√≥n"/></div>
            <div class="col-md-4 d-grid"><button id="btnAddPartner" class="btn btn-primary btn-sm">Agregar Socio</button></div>
          </div>
          <div id="partnersContainer"></div>
        </div>
      </div>
      
      <!-- Gesti√≥n de Encargados por POS -->
      <div class="col-12">
        <div class="tile">
          <h6>Encargados por POS</h6>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Encargado de Barra</label>
              <input id="encargadoBarra" class="form-control form-control-sm" placeholder="Nombre del encargado">
            </div>
            <div class="col-md-6">
              <label class="form-label">Encargado de Granizados</label>
              <input id="encargadoGranizados" class="form-control form-control-sm" placeholder="Nombre del encargado">
            </div>
            <div class="col-12">
              <button id="btnGuardarEncargados" class="btn btn-success btn-sm">Guardar Encargados</button>
            </div>
          </div>
          <div id="encargadosActuales" class="mt-2"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Socios - VERSI√ìN ACTUALIZADA CON NAVEGACI√ìN DE CIERRES AVANZADOS -->
  <section id="socios" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Cierres + Reparto</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    
    <!-- Navegaci√≥n de cierres -->
    <div class="nav-cierres mt-3">
      <button onclick="mostrarCierre('diario')" class="nav-cierre-btn active">
        üìä Cierre Diario
      </button>
      <button onclick="mostrarCierre('semanal')" class="nav-cierre-btn">
        üìà Cierre Semanal
      </button>
      <button onclick="mostrarCierre('administracion')" class="nav-cierre-btn">
        üõ†Ô∏è Administraci√≥n Avanzada
      </button>
    </div>
    
    <!-- Contenedor Cierre Diario -->
    <div id="cierre-diario-container" class="cierre-container active">
      <div class="row g-2 mt-2">
        <div class="col-12 tile">
          <h6>üîÆ Inferir Ventas en Efectivo</h6>
          <div class="d-flex flex-wrap gap-2 mb-3">
            <button onclick="ejecutarInferencia('Barra')" class="btn-inferir">
              ‚ö° Inferir Barra
            </button>
            <button onclick="ejecutarInferencia('Granizados')" class="btn-inferir">
              ‚ö° Inferir Granizados
            </button>
          </div>
          <div id="resultado-inferencia"></div>
        </div>
        
        <div class="col-12 tile">
          <h6>üí∞ Cierre Diario</h6>
          <div class="d-flex flex-wrap gap-2">
            <input type="date" id="fechaDia" class="form-control" style="max-width:200px">
            <button id="btnCierreDia" class="btn btn-dark">Generar</button>
            <div class="vr"></div>
            <input type="number" id="efContadoBarra" class="form-control" placeholder="Efectivo contado Barra" style="max-width:220px">
            <input type="number" id="efContadoGrz" class="form-control" placeholder="Efectivo contado Granizados" style="max-width:260px">
            <button onclick="calcularYRegistrarDescuadres()" class="btn btn-outline-danger">Calcular Descuadres</button>
          </div>
          <div id="cierreDia" class="mt-3"></div>
          <div id="resultado-descuadres" class="mt-2"></div>
        </div>
      </div>
    </div>
    
    <!-- Contenedor Cierre Semanal -->
    <div id="cierre-semanal-container" class="cierre-container">
      <div class="row g-2 mt-2">
        <div class="col-12 tile">
          <h6>üìà Cierre Semanal + Reparto</h6>
          <div class="d-flex gap-2 mb-3">
            <input type="date" id="semDesde" class="form-control" style="max-width:200px">
            <input type="date" id="semHasta" class="form-control" style="max-width:200px">
            <button onclick="recalcularCierreSemanal()" class="btn btn-dark">Generar</button>
          </div>
          
          <!-- Gastos Semanales Extra -->
          <div class="gastos-extra-form">
            <h6>üí∏ Gastos Semanales Extra</h6>
            <div class="row g-2">
              <div class="col-md-4">
                <input type="text" id="concepto-extra" class="form-control form-control-sm" placeholder="Concepto (cemento, pintura...)">
              </div>
              <div class="col-md-3">
                <input type="number" id="monto-extra" class="form-control form-control-sm" placeholder="Monto" min="0">
              </div>
              <div class="col-md-3">
                <input type="text" id="atribuido-extra" class="form-control form-control-sm" placeholder="Atribuido a (opcional)">
              </div>
              <div class="col-md-2">
                <button onclick="agregarGastoExtra()" class="btn btn-primary btn-sm w-100">‚ûï Agregar</button>
              </div>
            </div>
            <div id="lista-gastos-extra" class="mt-2"></div>
          </div>
          
          <div class="row g-2">
            <div class="col-12 col-lg-6">
              <div id="metricas-periodo" class="loading">Selecciona un per√≠odo para ver m√©tricas</div>
            </div>
            <div class="col-12 col-lg-6">
              <div id="tabla-reparto" class="loading">El reparto se mostrar√° despu√©s de calcular m√©tricas</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Contenedor Administraci√≥n -->
    <div id="administracion-container" class="cierre-container">
      <div class="tile mt-2">
        <h6>üõ†Ô∏è Administraci√≥n Avanzada</h6>
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <h6>üí∏ Deudores</h6>
            <div id="lista-deudores-admin" class="mt-2">
              <button onclick="cargarDeudoresAdmin()" class="btn btn-outline-primary">Cargar Deudores</button>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <h6>üìä Reportes</h6>
            <div class="row g-2">
              <div class="col-6">
                <input type="date" id="fecha-inicio-reporte" class="form-control form-control-sm">
              </div>
              <div class="col-6">
                <input type="date" id="fecha-fin-reporte" class="form-control form-control-sm">
              </div>
              <div class="col-12">
                <button onclick="generarReporte()" class="btn btn-info btn-sm w-100">üìà Generar Reporte</button>
              </div>
            </div>
            <div id="resultados-reporte" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="sticky-footer d-flex justify-content-between align-items-center">
  <div class="small text-muted">Inst√°lala como PWA (Agregar a pantalla de inicio). Guarda en Supabase.</div>
  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-secondary" data-goto="home">Inicio</button>
  </div>
</div>

<div id="health" style="position:fixed;right:8px;bottom:8px;font:12px system-ui;background:#111;color:#fff;padding:6px 10px;border-radius:8px;opacity:.9;z-index:9999">Cargando‚Ä¶</div>

<!-- CARGAR SISTEMA DE CIERRES AVANZADOS -->
<script src="cierre-avanzado.js?v=7"></script>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const ok = (t)=>{ const el=document.getElementById('health'); el.textContent=t; el.style.background='#198754'; };
  const bad = (t)=>{ const el=document.getElementById('health'); el.textContent=t; el.style.background='#dc3545'; };
  try{
    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const { error } = await supabase.from('products').select('id', { count: 'exact', head: true });
    if(error) bad('Supabase: ERROR'); else ok('Supabase: OK');
    setTimeout(()=>document.getElementById('health').remove(), 2500);
  }catch(e){ bad('JS error'); }
</script>
  
<script type="module">
  import { 
    supabase, q, money, 
    getProducts, addProduct, updateProduct, deleteProduct,
    getEmployees, addEmployee,
    getPartners, addPartner, updatePartner, deletePartner,
    addSale, addPurchase, addExpense, addPayrollDay,
    upsertCounts, getCounts,
    fetchDayClose, fetchRangeClose, deleteSale, deletePurchase, deleteExpense,
    logActivity, validateSaleData, resetAllData, getDashboardData
  } from './supabaseClient.js?v=7';

  // ==== Fecha local consistente + getter del selector ====
  const localISODate = () => {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  };
  const getSelectedDate = () => document.getElementById('appDate').value || localISODate();
  document.getElementById('appDate').value = localISODate();
  document.getElementById('appDate').addEventListener('change', () => {
    renderVentas();
  });

  const goto = (id)=>['home','mesero','pos','socios','admin'].forEach(s=>document.getElementById(s).hidden=(s!==id));
  document.querySelectorAll('[data-goto]').forEach(b=>b.onclick=()=>goto(b.dataset.goto));
  goto('home');

  // ===== INTEGRACI√ìN CON CIERRES AVANZADOS =====

  // Funciones de navegaci√≥n entre cierres
  window.mostrarCierre = function(tipo) {
    // Ocultar todos los contenedores
    document.querySelectorAll('.cierre-container').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.nav-cierre-btn').forEach(btn => btn.classList.remove('active'));
    
    // Mostrar contenedor seleccionado
    document.getElementById(`${tipo}-container`).classList.add('active');
    document.querySelector(`[onclick="mostrarCierre('${tipo}')"]`).classList.add('active');
    
    // Inicializar datos espec√≠ficos
    setTimeout(() => {
      switch(tipo) {
        case 'diario':
          if (typeof actualizarEfectivoEsperado === 'function') {
            actualizarEfectivoEsperado();
          }
          break;
        case 'semanal':
          if (typeof inicializarCierreSemanal === 'function') {
            inicializarCierreSemanal();
          }
          break;
        case 'administracion':
          if (typeof inicializarVistaAdministracion === 'function') {
            inicializarVistaAdministracion();
          }
          break;
      }
    }, 100);
  };

  // Funciones globales necesarias para el sistema avanzado
  window.supabase = supabase;
  window.money = money;
  window.getSelectedDate = getSelectedDate;
  window.getDashboardData = getDashboardData;

  // ============ PRODUCTOS ============
  let products = [];
  let employees = [];

  async function loadProducts(){
    try {
      products = await getProducts();
      window.products = products; // Hacer disponible globalmente
      rebuildSelects();
      renderProductsTable();
    } catch(e) {
      console.error('Error loading products:', e);
      alert('Error cargando cat√°logo');
    }
  }

  function rebuildSelects(){
    const pos = document.getElementById('ventaPOS').value;
    document.getElementById('ventaProd').innerHTML = products.filter(p=>p.pos===pos && p.type==='producto').map(p=>`<option value="${p.id}">${p.name} (${p.sku})</option>`).join('');
    document.getElementById('compraProd').innerHTML = products.map(p=>`<option value="${p.id}">${p.name} (${p.sku})</option>`).join('');
  }

  function renderProductsTable() {
    const tbody = document.querySelector('#tblProducts tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    products.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${money(p.price)}</td>
        <td><span class="pos-pill pos-${p.pos}">${p.pos}</span></td>
        <td>${p.vasos_per_unit || 0}</td>
        <td><span class="badge bg-info">Ver stock</span></td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${p.id}')">Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeProduct('${p.id}')">Borrar</button>
        </td>`;
      tbody.appendChild(tr);
    });
    
    console.log(`Products rendered: ${products.length}`);
  }

  // Agregar producto
  document.getElementById('btnAddProduct').addEventListener('click', async () => {
    const sku = document.getElementById('prodSKU').value.trim();
    const name = document.getElementById('prodName').value.trim();
    const price = +document.getElementById('prodPrice').value || 0;
    const pos = document.getElementById('prodPOS').value;
    const vasos_per_unit = +document.getElementById('prodVasos').value || 0;

    if (!sku || !name || price <= 0) {
      return alert('Complete SKU, nombre y precio v√°lido');
    }

    try {
      await addProduct({ sku, name, price, pos, vasos_per_unit });
      alert('Producto agregado');
      
      // Limpiar form
      document.getElementById('prodSKU').value = '';
      document.getElementById('prodName').value = '';
      document.getElementById('prodPrice').value = '';
      document.getElementById('prodVasos').value = '0';
      
      await loadProducts();
    } catch(e) {
      console.error(e);
      alert('Error agregando producto: ' + e.message);
    }
  });

  // Funciones globales para editar/borrar productos
  window.editProduct = async (id) => {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    const newName = prompt('Nuevo nombre:', product.name);
    const newPrice = prompt('Nuevo precio:', product.price);
    
    if (newName && newPrice && +newPrice > 0) {
      try {
        await updateProduct(id, { name: newName.trim(), price: +newPrice });
        alert('Producto actualizado');
        await loadProducts();
      } catch(e) {
        alert('Error actualizando: ' + e.message);
      }
    }
  };

  window.removeProduct = async (id) => {
    if (!confirm('¬øDesactivar este producto?')) return;
    try {
      await deleteProduct(id);
      alert('Producto desactivado');
      await loadProducts();
    } catch(e) {
      alert('Error desactivando: ' + e.message);
    }
  };

  // ============ EMPLEADOS ============
  async function loadEmployees(){
    try {
      employees = await getEmployees();
      window.employees = employees; // Hacer disponible globalmente
      renderEmployeesTable();
    } catch(e) {
      console.error('Error loading employees:', e);
    }
  }

  function renderEmployeesTable() {
    const tbody = document.querySelector('#tblEmployees tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    employees.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.name}</td>
        <td>${e.role}</td>
        <td>${money(e.daily_salary)}</td>
        <td><span class="badge bg-${e.active ? 'success' : 'secondary'}">${e.active ? 'Activo' : 'Inactivo'}</span></td>`;
      tbody.appendChild(tr);
    });
    
    console.log(`Employees rendered: ${employees.length}`);
  }

  // Agregar empleado
  document.getElementById('btnAddEmployee').addEventListener('click', async () => {
    const name = document.getElementById('empName').value.trim();
    const role = document.getElementById('empRole').value.trim();
    const daily_salary = +document.getElementById('empSalary').value || 0;

    if (!name || !role || daily_salary <= 0) {
      return alert('Complete nombre, cargo y salario v√°lido');
    }

    try {
      await addEmployee({ name, role, daily_salary });
      alert('Empleado agregado');
      
      // Limpiar form
      document.getElementById('empName').value = '';
      document.getElementById('empRole').value = '';
      document.getElementById('empSalary').value = '';
      
      await loadEmployees();
      await updateDashboard();
    } catch(e) {
      alert('Error agregando empleado: ' + e.message);
    }
  });

  // ============ MANEJO DE PAGO MIXTO ============
  function updateTotalAPagar() {
    const productId = document.getElementById('ventaProd').value;
    const qty = +document.getElementById('ventaCant').value || 1;
    const product = products.find(p => p.id === productId);
    const total = product ? product.price * qty : 0;
    document.getElementById('totalAPagar').textContent = money(total);
    return total;
  }

  // Mostrar/ocultar campos mixto
  document.getElementById('ventaPago').addEventListener('change', function() {
    const payMethod = this.value;
    const mixtoFields = document.getElementById('mixtoFields');
    
    if (payMethod === 'Mixto') {
      mixtoFields.classList.add('show');
      updateTotalAPagar();
    } else {
      mixtoFields.classList.remove('show');
      document.getElementById('ventaEfectivo').value = 0;
      document.getElementById('ventaTransferencia').value = 0;
    }
  });

  // Actualizar total cuando cambie producto o cantidad
  document.getElementById('ventaProd').addEventListener('change', updateTotalAPagar);
  document.getElementById('ventaCant').addEventListener('input', updateTotalAPagar);

  // Validar suma en tiempo real para pago mixto
  function validateMixto() {
    const efectivo = +document.getElementById('ventaEfectivo').value || 0;
    const transferencia = +document.getElementById('ventaTransferencia').value || 0;
    const total = updateTotalAPagar();
    
    const suma = efectivo + transferencia;
    const btnAdd = document.getElementById('btnAddVenta');
    
    if (document.getElementById('ventaPago').value === 'Mixto') {
      if (suma === total) {
        btnAdd.disabled = false;
        btnAdd.textContent = editingSale ? 'Guardar cambios' : 'Agregar venta';
        btnAdd.className = 'btn btn-success btn-fat mt-2';
      } else {
        btnAdd.disabled = true;
        btnAdd.textContent = `Falta ${money(total - suma)} (Total: ${money(total)})`;
        btnAdd.className = 'btn btn-outline-danger btn-fat mt-2';
      }
    } else {
      btnAdd.disabled = false;
      btnAdd.textContent = editingSale ? 'Guardar cambios' : 'Agregar venta';
      btnAdd.className = 'btn btn-success btn-fat mt-2';
    }
  }

  document.getElementById('ventaEfectivo').addEventListener('input', validateMixto);
  document.getElementById('ventaTransferencia').addEventListener('input', validateMixto);
  document.getElementById('ventaPOS').addEventListener('change', rebuildSelects);

  // Estado edici√≥n
  let editingSale = null;

  // Validaci√≥n en tiempo real
  function showValidationErrors(errors) {
    const errorDiv = document.getElementById('saleValidationErrors');
    if (errors.length > 0) {
      errorDiv.innerHTML = errors.map(err => `<div class="validation-error">${err}</div>`).join('');
      errorDiv.style.display = 'block';
      return false;
    } else {
      errorDiv.style.display = 'none';
      return true;
    }
  }
  
  // Add / Update sale
  document.getElementById('btnAddVenta').addEventListener('click', async()=>{
    const pos = document.getElementById('ventaPOS').value;
    const product_id = document.getElementById('ventaProd').value;
    const qty = +document.getElementById('ventaCant').value || 1;
    const pay_method = document.getElementById('ventaPago').value;
    const notes = document.getElementById('ventaNotas').value.trim();
    const date = getSelectedDate();
    const time = new Date().toTimeString().slice(0,8);
    
    // Obtener cash_amount y transfer_amount seg√∫n m√©todo de pago
    let cash_amount = 0;
    let transfer_amount = 0;
    
    if (pay_method === 'Mixto') {
      cash_amount = +document.getElementById('ventaEfectivo').value || 0;
      transfer_amount = +document.getElementById('ventaTransferencia').value || 0;
    }
    
    // Validar datos b√°sicos (simplificado)
    if (!product_id) {
      showValidationErrors(['Debe seleccionar un producto']);
      return;
    }
    
    if (!qty || qty <= 0) {
      showValidationErrors(['La cantidad debe ser mayor a 0']);
      return;
    }
    
    if (pay_method === 'Mixto') {
      if ((cash_amount + transfer_amount) <= 0) {
        showValidationErrors(['En pago mixto debe especificar efectivo y/o transferencia']);
        return;
      }
    }
    
    // Limpiar errores si todo est√° bien
    showValidationErrors([]);
    
    try{
      if(editingSale){
        await deleteSale(editingSale.id);
        await addSale({
          date,
          time: editingSale.time || time,
          pos,
          product_id,
          qty,
          pay_method,
          cash_amount,
          transfer_amount,
          notes
        });
        editingSale = null;
        document.getElementById('btnAddVenta').textContent = 'Agregar venta';
        alert('Venta actualizada');
      }else{
        await addSale({
          date,
          time,
          pos,
          product_id,
          qty,
          pay_method,
          cash_amount,
          transfer_amount,
          notes
        });
        alert('Venta registrada');
      }
      
      // Limpiar formulario
      document.getElementById('ventaCant').value = 1;
      document.getElementById('ventaNotas').value = '';
      document.getElementById('ventaEfectivo').value = 0;
      document.getElementById('ventaTransferencia').value = 0;
      document.getElementById('ventaPago').value = 'Efectivo';
      document.getElementById('mixtoFields').classList.remove('show');
      
      await renderVentas();
      await updateDashboard();
    }catch(e){ 
      console.error(e); 
      alert('Error guardando venta: ' + e.message); 
    }
  });

  async function renderVentas(){
    const d = getSelectedDate();
    const { data, error } = await supabase
      .from('sales')
      .select('*, products(name,price,pos)')
      .eq('date', d)
      .order('time');
    
    if (error) {
      console.error('Error loading sales:', error);
      return;
    }
    
    const tb = document.querySelector('#tblVentas tbody'); 
    tb.innerHTML='';
    
    (data||[]).forEach(v=>{
      const total = v.cash_amount + v.transfer_amount;
      let pagoDisplay = v.pay_method;
      
      // Mostrar desglose si es mixto
      if (v.pay_method === 'Mixto') {
        pagoDisplay = `Mixto (E:${money(v.cash_amount)} T:${money(v.transfer_amount)})`;
      }
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${v.date}</td>
        <td>${v.time}</td>
        <td><span class="pos-pill pos-${v.pos}">${v.pos}</span></td>
        <td>${v.products?.name||''}</td>
        <td>${v.qty}</td>
        <td>${pagoDisplay}</td>
        <td>${money(total)}</td>
        <td>
          <span class="text-primary me-2" style="cursor:pointer" data-edit='${JSON.stringify({
            id:v.id, 
            date:v.date, 
            time:v.time, 
            pos:v.pos, 
            product_id:v.product_id, 
            qty:v.qty, 
            pay_method:v.pay_method, 
            cash_amount: v.cash_amount,
            transfer_amount: v.transfer_amount,
            notes:v.notes||''
          }).replace(/"/g,'&quot;')}'>Editar</span>
          <span class="text-danger" style="cursor:pointer" data-del="${v.id}">Borrar</span>
        </td>`;
      tb.appendChild(tr);
    });

    // Borrar (CON BUG FIX - actualiza inmediatamente la UI)
    tb.querySelectorAll('[data-del]').forEach(el=>{
      el.onclick = async () => {
        if(!confirm('¬øBorrar venta? Esto revierte el inventario.')) return;
        try { 
          await deleteSale(el.dataset.del); 
          await renderVentas(); 
        }
        catch(e){ 
          console.error(e); 
          alert('Error borrando: ' + e.message); 
        }
      };
    });
    
    // Editar
    tb.querySelectorAll('[data-edit]').forEach(el=>{
      el.onclick = () => {
        const v = JSON.parse(el.dataset.edit.replace(/&quot;/g,'"'));
        editingSale = v;
        document.getElementById('ventaPOS').value = v.pos;
        rebuildSelects();
        document.getElementById('ventaProd').value = v.product_id;
        document.getElementById('ventaCant').value = v.qty;
        document.getElementById('ventaPago').value = v.pay_method;
        document.getElementById('ventaNotas').value = v.notes || '';
        document.getElementById('appDate').value = v.date;
        
        // Configurar campos mixto si es necesario
        if (v.pay_method === 'Mixto') {
          document.getElementById('mixtoFields').classList.add('show');
          document.getElementById('ventaEfectivo').value = v.cash_amount || 0;
          document.getElementById('ventaTransferencia').value = v.transfer_amount || 0;
        } else {
          document.getElementById('mixtoFields').classList.remove('show');
        }
        
        document.getElementById('btnAddVenta').textContent = 'Guardar cambios';
        goto('mesero');
      };
    });
  }

  // ============ INVENTARIO MEJORADO ============
  async function cargarInventario() {
    const pos = document.getElementById('invPOS').value;
    const date = getSelectedDate();
    
    try {
      // Intentar cargar desde cach√© primero
      const cacheKey = `inventory_${pos}_${date}`;
      const cachedData = JSON.parse(localStorage.getItem(cacheKey) || '{}');
      
      // Obtener conteos de Supabase
      const existingCounts = await getCounts(date, pos);
      
      // Obtener productos del POS
      const posProducts = products.filter(p => p.pos === pos && p.type === 'producto');
      
      let html = `
        <div class="alert alert-info">
          <strong>Inventario ${pos} - ${date}</strong>
          <div class="small">üí° Tip: Los datos se guardan autom√°ticamente y persisten al refrescar</div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr><th>SKU</th><th>Producto</th><th>Inicial</th><th>Final</th></tr>
            </thead>
            <tbody>`;
      
      posProducts.forEach(product => {
        // Prioridad: cach√© > supabase > 0
        const cached = cachedData[product.id];
        const existing = existingCounts.find(c => c.product_id === product.id);
        
        const initial = cached?.initial_qty ?? existing?.initial_qty ?? 0;
        const final = cached?.final_qty ?? existing?.final_qty ?? 0;
        
        html += `
          <tr>
            <td>${product.sku}</td>
            <td>${product.name}</td>
            <td><input type="number" class="editable-count" value="${initial}" data-pid="${product.id}" data-type="initial" min="0"></td>
            <td><input type="number" class="editable-count" value="${final}" data-pid="${product.id}" data-type="final" min="0"></td>
          </tr>`;
      });
      
      html += `</tbody></table></div>`;
      document.getElementById('inventarioContainer').innerHTML = html;
      
      console.log(`Inventario cargado para ${pos}: ${posProducts.length} productos`);
      
    } catch(e) {
      console.error('Error cargando inventario:', e);
      alert('Error cargando inventario: ' + e.message);
    }
  }

  document.getElementById('btnCargarConteo').addEventListener('click', cargarInventario);

  // Guardar inventario
  document.getElementById('btnGuardarInventario').addEventListener('click', async () => {
    const pos = document.getElementById('invPOS').value;
    const date = getSelectedDate();
    
    const rows = [];
    document.querySelectorAll('#inventarioContainer input[data-pid]').forEach(input => {
      const pid = input.dataset.pid;
      const type = input.dataset.type;
      const value = +input.value || 0;
      
      let existing = rows.find(r => r.product_id === pid);
      if (!existing) {
        existing = { product_id: pid, initial_qty: 0, final_qty: 0 };
        rows.push(existing);
      }
      
      if (type === 'initial') existing.initial_qty = value;
      if (type === 'final') existing.final_qty = value;
    });
    
    try {
      await upsertCounts({ date, pos, rows });
      alert('‚úÖ Inventario guardado exitosamente');
      
      // Guardar tambi√©n en localStorage para persistencia
      const cacheKey = `inventory_${pos}_${date}`;
      const cacheData = {};
      rows.forEach(row => {
        cacheData[row.product_id] = {
          initial_qty: row.initial_qty,
          final_qty: row.final_qty
        };
      });
      localStorage.setItem(cacheKey, JSON.stringify(cacheData));
      
      console.log('Inventario guardado y cacheado para', pos, date);
      await updateDashboard();
    } catch(e) {
      console.error('Error guardando inventario:', e);
      alert('‚ùå Error guardando inventario: ' + e.message);
    }
  });

  // ============ N√ìMINA ============
  let selectedEmployees = [];

  document.getElementById('btnCargarEmpleados').addEventListener('click', () => {
    if (employees.length === 0) {
      return alert('No hay empleados registrados. Ve a Administraci√≥n para agregar empleados.');
    }
    
    let html = '<div class="row g-2">';
    employees.forEach(emp => {
      html += `
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center p-2" style="background: white; border: 1px solid #dee2e6; border-radius: 4px;">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="${emp.id}" id="emp${emp.id}">
              <label class="form-check-label" for="emp${emp.id}">
                <strong>${emp.name}</strong> - ${emp.role}
              </label>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label class="small">$</label>
              <input type="number" min="0" value="${emp.daily_salary}" 
                     class="form-control form-control-sm salary-input" 
                     id="salary_${emp.id}" style="width:100px;">
            </div>
          </div>
        </div>`;
    });
    html += '</div>';
    
    document.getElementById('nominaContainer').innerHTML = html;
    document.getElementById('btnPagarNomina').style.display = 'block';
  });

  document.getElementById('btnPagarNomina').addEventListener('click', async () => {
    const checkedInputs = document.querySelectorAll('#nominaContainer input[type="checkbox"]:checked');
    
    if (checkedInputs.length === 0) {
      return alert('Selecciona al menos un empleado');
    }
    
    const date = getSelectedDate();
    const selectedEmps = Array.from(checkedInputs).map(input => {
      const empId = input.value;
      const emp = employees.find(e => e.id == empId);
      const salaryInput = document.getElementById(`salary_${empId}`);
      const actualSalary = salaryInput ? (+salaryInput.value || emp.daily_salary) : emp.daily_salary;
      return {
        name: emp.name,
        role: emp.role,
        salary: actualSalary
      };
    });
    
    try {
      await addPayrollDay({ date, employees: selectedEmps });
      alert(`N√≥mina registrada para ${selectedEmps.length} empleados`);
      
      // Limpiar selecci√≥n
      document.getElementById('nominaContainer').innerHTML = '';
      document.getElementById('btnPagarNomina').style.display = 'none';
      await updateDashboard(); // ACTUALIZAR INTERFAZ
      
    } catch(e) {
      console.error('Error registrando n√≥mina:', e);
      alert('Error registrando n√≥mina: ' + e.message);
    }
  });

  // Purchases
  document.getElementById('btnAddCompra').addEventListener('click', async()=>{
    const product_id = document.getElementById('compraProd').value;
    const qty = +document.getElementById('compraCant').value||0;
    const unit_cost = +document.getElementById('compraPU').value||0;
    const notes = document.getElementById('compraNotas').value.trim();
    const file = document.getElementById('compraFile').files[0]||null;
    const date = getSelectedDate();
    const pos = products.find(p=>p.id===product_id)?.pos || 'Barra';
    try{
      await addPurchase({date,pos,product_id,qty,unit_cost,notes,file});
      alert('Compra registrada');
      document.getElementById('compraCant').value=1; document.getElementById('compraPU').value=0; document.getElementById('compraNotas').value=''; document.getElementById('compraFile').value='';
      await updateDashboard(); // ACTUALIZAR INTERFAZ
    }catch(e){ console.error(e); alert('Error guardando compra'); }
  });

  // Manejar cambio de tipo de gasto
  document.getElementById('gastoTipo').addEventListener('change', function() {
    const tipo = this.value;
    const inputAtrib = document.getElementById('gastoAtrib');
    const selectSocio = document.getElementById('gastoSocioSelect');
    
    if (tipo === 'DescuentoSocio') {
      inputAtrib.style.display = 'none';
      selectSocio.style.display = 'block';
    } else {
      inputAtrib.style.display = 'block';
      selectSocio.style.display = 'none';
    }
  });

  // Expenses
  document.getElementById('btnAddGasto').addEventListener('click', async()=>{
    const type = document.getElementById('gastoTipo').value;
    const concept = document.getElementById('gastoConcepto').value.trim();
    const amount = +document.getElementById('gastoValor').value||0;
    
    // Obtener attributed_to dependiendo del tipo
    let attributed_to = '';
    if (type === 'DescuentoSocio') {
      attributed_to = document.getElementById('gastoSocioSelect').value;
      if (!attributed_to) {
        return alert('Debe seleccionar un socio para el descuento');
      }
    } else {
      attributed_to = document.getElementById('gastoAtrib').value.trim();
    }
    
    const notes = document.getElementById('gastoNotas').value.trim();
    const date = getSelectedDate();
    try{ 
      await addExpense({date,type,concept,amount,attributed_to,notes}); 
      alert('Gasto registrado');
      // Limpiar form
      document.getElementById('gastoConcepto').value = '';
      document.getElementById('gastoValor').value = '';
      document.getElementById('gastoAtrib').value = '';
      document.getElementById('gastoSocioSelect').value = '';
      document.getElementById('gastoNotas').value = '';
      await updateDashboard(); // ACTUALIZAR INTERFAZ
    }catch(e){ alert('Error guardando gasto'); }
  });

  // ===== Cierres B√°sicos (mantener funcionalidad original) =====
  let cacheCierreDia = null;
  document.getElementById('btnCierreDia').addEventListener('click', async()=>{
    const f = document.getElementById('fechaDia').value || getSelectedDate();
    const { sales, expenses } = await fetchDayClose(f);
    const porPOS = (pos) => (sales||[]).filter(x=>x.pos===pos).reduce((acc,cur)=>{
      acc.total += (cur.cash_amount + cur.transfer_amount); 
      acc.ef += cur.cash_amount;
      acc.tr += cur.transfer_amount;
      return acc;
    }, {total:0, ef:0, tr:0});
    const barra = porPOS('Barra'); const grz = porPOS('Granizados');

    let gto=0, nom=0, dss=0;
    (expenses||[]).forEach(e=>{ if(e.type==='Gasto') gto+=e.amount; else if(e.type==='Nomina') nom+=e.amount; else if(e.type==='DescuentoSocio') dss+=e.amount; });

    const efBarraEsp = barra.ef;
    const efGrzEsp = grz.ef;
    cacheCierreDia = { fecha:f, efBarraEsp, efGrzEsp };

    document.getElementById('cierreDia').innerHTML = `
      <div class="row g-2">
        <div class="col-12 col-lg-6"><div class="tile"><h6>Barra</h6><div>Total: <b>${money(barra.total)}</b></div><div>Efectivo esperado: <b>${money(efBarraEsp)}</b> ¬∑ Transf: ${money(barra.tr)}</div></div></div>
        <div class="col-12 col-lg-6"><div class="tile"><h6>Granizados</h6><div>Total: <b>${money(grz.total)}</b></div><div>Efectivo esperado: <b>${money(efGrzEsp)}</b> ¬∑ Transf: ${money(grz.tr)}</div></div></div>
      </div>`;
  });

  document.getElementById('btnReset').addEventListener('click', ()=>{
    if('caches' in window){ caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))); }
    alert('Cache PWA limpiada. (Los datos viven en Supabase)');
  });

  // ============ DASHBOARD Y KPIS ============
  let partners = [];
  
  async function updateDashboard() {
    const date = getSelectedDate();
    try {
      const data = await getDashboardData(date);
      
      // Calcular KPIs
      const totalVentas = data.sales.reduce((sum, s) => sum + s.cash_amount + s.transfer_amount, 0);
      const totalGastos = data.expenses.reduce((sum, e) => sum + e.amount, 0);
      const totalCompras = data.purchases.reduce((sum, p) => sum + (p.qty * p.unit_cost), 0);
      const utilidadDia = totalVentas - totalGastos - totalCompras;
      
      // Renderizar KPIs
      const kpisHTML = `
        <div class="col-6 col-md-3">
          <div class="kpi-card" style="background: linear-gradient(135deg, #28a745, #20c997);">
            <div class="kpi-value">${money(totalVentas)}</div>
            <div class="kpi-label">Ventas del d√≠a</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="kpi-card" style="background: linear-gradient(135deg, #dc3545, #fd7e14);">
            <div class="kpi-value">${money(totalGastos)}</div>
            <div class="kpi-label">Gastos del d√≠a</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="kpi-card" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);">
            <div class="kpi-value">${money(totalCompras)}</div>
            <div class="kpi-label">Compras del d√≠a</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="kpi-card" style="background: linear-gradient(135deg, ${utilidadDia >= 0 ? '#28a745, #20c997' : '#dc3545, #fd7e14'});">
            <div class="kpi-value">${money(utilidadDia)}</div>
            <div class="kpi-label">Utilidad estimada</div>
          </div>
        </div>`;
      
      document.getElementById('dashboardKPIs').innerHTML = kpisHTML;
      
      // Renderizar actividad reciente
      const activityHTML = data.recentLog.map(log => `
        <div class="activity-item">
          <strong>${log.time}</strong> - ${log.action.replace(/_/g, ' ')} en ${log.table_name}
          ${log.details ? '<br><small class="text-muted">' + JSON.stringify(log.details).substring(0, 100) + '</small>' : ''}
        </div>
      `).join('');
      
      if (document.getElementById('activityLog')) {
        document.getElementById('activityLog').innerHTML = activityHTML || '<div class="text-muted">Sin actividad registrada</div>';
      }
      
      // Renderizar compras del d√≠a
      const comprasHTML = data.purchases.map(p => `
        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
          <div>
            <strong>${p.products?.name || 'Producto'}</strong> x${p.qty}
            <br><small class="text-muted">${p.notes || ''}</small>
          </div>
          <div class="text-end">
            <div>${money(p.qty * p.unit_cost)}</div>
            <div class="small">
              <span class="text-primary" style="cursor:pointer" onclick="editPurchase('${p.id}')">Editar</span> |
              <span class="text-danger" style="cursor:pointer" onclick="deletePurchase('${p.id}')">Borrar</span>
            </div>
          </div>
        </div>
      `).join('');
      
      if (document.getElementById('comprasDelDia')) {
        document.getElementById('comprasDelDia').innerHTML = comprasHTML || '<div class="text-muted">Sin compras registradas</div>';
      }
      
      // Renderizar gastos del d√≠a
      const gastosHTML = data.expenses.map(e => `
        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
          <div>
            <strong>${e.concept}</strong> (${e.type})
            <br><small class="text-muted">${e.attributed_to || ''}</small>
          </div>
          <div class="text-end">
            <div>${money(e.amount)}</div>
            <div class="small">
              <span class="text-primary" style="cursor:pointer" onclick="editExpense('${e.id}')">Editar</span> |
              <span class="text-danger" style="cursor:pointer" onclick="deleteExpense('${e.id}')">Borrar</span>
            </div>
          </div>
        </div>
      `).join('');
      
      if (document.getElementById('gastosDelDia')) {
        document.getElementById('gastosDelDia').innerHTML = gastosHTML || '<div class="text-muted">Sin gastos registrados</div>';
      }
      
    } catch(e) {
      console.error('Error updating dashboard:', e);
    }
  }

  // ============ GESTI√ìN DE SOCIOS ============
  async function loadPartners() {
    try {
      partners = await getPartners();
      renderPartnersTable();
      updateGastoSociosSelect(); // Actualizar select de gastos
    } catch(e) {
      console.error('Error loading partners:', e);
    }
  }

  function updateGastoSociosSelect() {
    const select = document.getElementById('gastoSocioSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">Seleccionar socio...</option>';
    partners.forEach(partner => {
      const option = document.createElement('option');
      option.value = partner.name;
      option.textContent = partner.name;
      select.appendChild(option);
    });
  }

  function renderPartnersTable() {
    const container = document.getElementById('partnersContainer');
    if (!container) return;
    
    const totalShare = partners.reduce((sum, p) => sum + parseFloat(p.share_pct), 0);
    
    let html = '';
    
    partners.forEach(partner => {
      html += `
        <div class="partner-item">
          <div class="flex-grow-1">
            <strong>${partner.name}</strong>
            <div class="small text-muted">${partner.share_pct}% de participaci√≥n</div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="editPartner('${partner.id}')">Editar</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deletePartnerConfirm('${partner.id}')">Eliminar</button>
          </div>
        </div>
      `;
    });
    
    html += `
      <div class="mt-2 p-2 ${totalShare === 100 ? 'bg-success' : 'bg-warning'} text-white rounded">
        <strong>Total: ${totalShare.toFixed(1)}%</strong>
        ${totalShare === 100 ? ' ‚úì Correcto' : ' ‚ö†Ô∏è Debe sumar 100%'}
      </div>
    `;
    
    container.innerHTML = html;
    console.log(`Partners rendered: ${partners.length}, Total: ${totalShare.toFixed(1)}%`);
  }

  // Funciones globales para socios
  window.editPartner = async function(id) {
    const partner = partners.find(p => p.id === id);
    if (!partner) return;
    
    const newName = prompt('Nuevo nombre:', partner.name);
    const newShare = prompt('Nuevo porcentaje:', partner.share_pct);
    
    if (newName && newShare && parseFloat(newShare) >= 0) {
      try {
        await updatePartner(id, { name: newName.trim(), share_pct: parseFloat(newShare) });
        await loadPartners(); // Recargar lista
        await updateDashboard(); // Actualizar dashboard
        alert('Socio actualizado exitosamente');
      } catch(e) {
        alert('Error actualizando socio: ' + e.message);
      }
    }
  };

  window.deletePartnerConfirm = async function(id) {
    const partner = partners.find(p => p.id === id);
    if (!partner) return;
    
    if (confirm(`¬øEliminar socio "${partner.name}"?`)) {
      try {
        await deletePartner(id);
        await loadPartners(); // Recargar lista
        await updateDashboard(); // Actualizar dashboard
        alert('Socio eliminado exitosamente');
      } catch(e) {
        alert('Error eliminando socio: ' + e.message);
      }
    }
  };

  // Agregar socio
  document.getElementById('btnAddPartner').addEventListener('click', async () => {
    const name = document.getElementById('partnerName').value.trim();
    const share_pct = parseFloat(document.getElementById('partnerShare').value) || 0;
    
    if (!name || share_pct <= 0) {
      return alert('Complete nombre y porcentaje v√°lido');
    }
    
    try {
      await addPartner({ name, share_pct });
      alert('Socio agregado exitosamente');
      
      // Limpiar form
      document.getElementById('partnerName').value = '';
      document.getElementById('partnerShare').value = '';
      
      await loadPartners();
    } catch(e) {
      alert('Error agregando socio: ' + e.message);
    }
  });

  // ============ GESTI√ìN DE ENCARGADOS ============
  document.getElementById('btnGuardarEncargados').addEventListener('click', async () => {
    const encargadoBarra = document.getElementById('encargadoBarra').value.trim();
    const encargadoGranizados = document.getElementById('encargadoGranizados').value.trim();
    
    if (!encargadoBarra || !encargadoGranizados) {
      return alert('Debe especificar encargados para ambos POS');
    }
    
    try {
      // Guardar en localStorage por ahora (luego podemos mover a Supabase si es necesario)
      localStorage.setItem('encargados', JSON.stringify({
        Barra: encargadoBarra,
        Granizados: encargadoGranizados
      }));
      
      alert('Encargados guardados exitosamente');
      mostrarEncargadosActuales();
      
      // Limpiar form
      document.getElementById('encargadoBarra').value = '';
      document.getElementById('encargadoGranizados').value = '';
    } catch(e) {
      alert('Error guardando encargados: ' + e.message);
    }
  });

  function mostrarEncargadosActuales() {
    const encargados = JSON.parse(localStorage.getItem('encargados') || '{}');
    const container = document.getElementById('encargadosActuales');
    
    if (encargados.Barra && encargados.Granizados) {
      container.innerHTML = `
        <div class="alert alert-info">
          <strong>Encargados actuales:</strong><br>
          üç∏ Barra: ${encargados.Barra}<br>
          üßä Granizados: ${encargados.Granizados}
        </div>
      `;
    } else {
      container.innerHTML = '<div class="text-muted">No hay encargados configurados</div>';
    }
  }

  // Funci√≥n global para obtener encargados
  window.getEncargados = function() {
    return JSON.parse(localStorage.getItem('encargados') || '{}');
  };

  // ============ FUNCIONES GLOBALES PARA EDITAR/BORRAR ============
  window.editPurchase = function(id) {
    alert('üöß Funci√≥n en desarrollo. Por ahora solo se pueden borrar compras.');
  };

  window.deletePurchase = async function(id) {
    if (!confirm('¬øEliminar esta compra? Esto revertir√° los cambios en el inventario.')) return;
    
    try {
      await deletePurchase(id);
      alert('‚úÖ Compra eliminada exitosamente');
      await updateDashboard();
    } catch (e) {
      alert('‚ùå Error eliminando compra: ' + e.message);
    }
  };

  window.editExpense = function(id) {
    alert('üöß Funci√≥n en desarrollo. Por ahora solo se pueden borrar gastos.');
  };

  window.deleteExpense = async function(id) {
    if (!confirm('¬øEliminar este gasto?')) return;
    
    try {
      await deleteExpense(id);
      alert('‚úÖ Gasto eliminado exitosamente');
      await updateDashboard();
    } catch (e) {
      alert('‚ùå Error eliminando gasto: ' + e.message);
    }
  };

  // ============ FUNCIONES GLOBALES DE UTILIDAD ============
  window.resetAllDataConfirm = async function() {
    alert(`üóëÔ∏è C√ìMO BORRAR TODO SIEMPRE:

1. Usa el bot√≥n "üóëÔ∏è Reset BD" (borra solo datos operativos)
2. O en Supabase SQL Editor ejecuta:
   DELETE FROM sales;
   DELETE FROM purchases; 
   DELETE FROM expenses;
   DELETE FROM inventory_counts;
   DELETE FROM inventory_moves;
   DELETE FROM activity_log;

3. En la app: Refresca (F5)

‚úÖ Se mantienen: productos, empleados, socios, encargados`);

    const confirmed = confirm(
      '‚ö†Ô∏è ADVERTENCIA: Esto borrar√° TODOS los datos operativos.\n\n' +
      'Solo se mantendr√°n productos, empleados y socios.\n\n' +
      '¬øContinuar?'
    );
    
    if (confirmed) {
      const doubleConfirm = prompt('Escribe "BORRAR TODO" para confirmar:');
      if (doubleConfirm === 'BORRAR TODO') {
        try {
          await resetAllData();
          // Limpiar tambi√©n localStorage
          Object.keys(localStorage).forEach(key => {
            if (key.startsWith('inventory_') || key.startsWith('cache_')) {
              localStorage.removeItem(key);
            }
          });
          alert('‚úÖ Todos los datos operativos eliminados exitosamente.');
          location.reload();
        } catch (e) {
          alert('‚ùå Error al eliminar datos: ' + e.message);
        }
      }
    }
  };
  
  window.exportDailyData = async function() {
    const date = getSelectedDate();
    const format = prompt('¬øEn qu√© formato deseas exportar?\n\n1. PDF (reporte)\n2. Excel (datos)\n3. JSON (backup)\n4. Completo (PDF + Excel)', '4');
    
    try {
      const data = await getDashboardData(date);
      
      switch(format) {
        case '1':
          await ExportUtils.exportDailyPDF(date, data);
          alert('üìÑ Reporte PDF exportado exitosamente');
          break;
        case '2':
          ExportUtils.exportToExcel(data, `datos_${date}.xlsx`);
          alert('üìä Datos Excel exportados exitosamente');
          break;
        case '3':
          const exportData = {
            fecha: date,
            ventas: data.sales,
            gastos: data.expenses,
            compras: data.purchases,
            inventario: data.counts,
            actividad: data.recentLog
          };
          
          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `backup_${date}.json`;
          a.click();
          URL.revokeObjectURL(url);
          alert('üíæ Backup JSON exportado exitosamente');
          break;
        case '4':
        default:
          await ExportUtils.exportCompleteReport(date);
          alert('üìäüìÑ Reporte completo exportado exitosamente (PDF + Excel)');
          break;
      }
    } catch (e) {
      alert('‚ùå Error al exportar: ' + e.message);
      console.error('Export error:', e);
    }
  };

  // init
  await loadProducts();
  await loadEmployees();
  await loadPartners();
  await renderVentas();
  await updateDashboard();
  mostrarEncargadosActuales(); // Mostrar encargados guardados
  
  // Auto-refresh dashboard cada 30 segundos
  setInterval(updateDashboard, 30000);

  // PWA SW register
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }
</script>
</body>
</html>