<!DOCTYPE html>
<html lang="es">
<head>
  <script src="./config.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Control Bar · PWA (Supabase)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    :root { --pad: 14px; }
    body { background:#f7f7f8; }
    .app { max-width: 1080px; margin: 0 auto; padding: var(--pad); }
    .tile { padding: 16px; border-radius: 16px; border:1px solid #eee; background:#fff; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .btn-fat { padding: 14px 16px; font-size: 18px; border-radius: 14px; }
    .kpi { border-radius: 14px; padding: 10px 12px; background:#fff; border: 1px solid #eee; }
    .kpi .v { font-weight:700; font-size: 18px; }
    .pos-pill { font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#111; color:#fff; }
    .pos-Barra { background: #0d6efd; }
    .pos-Granizados { background: #198754; }
    .table-sm td, .table-sm th { padding: .45rem .5rem; }
    .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #eee; padding: 8px 12px; z-index: 1000; }
    .muted-hint{font-size:12px;color:#6c757d}
    .mixto-fields { display: none; }
    .mixto-fields.show { display: block; }
    .admin-section { border-left: 4px solid #ffc107; background: #fffbf0; }
    .editable-count { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 4px 8px; min-width: 60px; text-align: center; }
  </style>
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "{{SUPABASE_URL}}";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "{{SUPABASE_ANON_KEY}}";
  </script>
</head>
<body>
<div class="app">
  <header class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="m-0">Control Bar · PWA</h4>
    <div class="d-flex align-items-center gap-2">
      <label class="form-label m-0">Fecha</label>
      <input id="appDate" type="date" class="form-control form-control-sm" style="min-width:150px">
      <button id="btnReset" class="btn btn-sm btn-outline-secondary">Reset local</button>
    </div>
  </header>

  <section id="home" class="tile">
    <div class="row g-2">
      <div class="col-12 col-md-3"><button class="w-100 btn btn-dark btn-fat" data-goto="mesero">Mesero · Venta rápida</button></div>
      <div class="col-12 col-md-3"><button class="w-100 btn btn-dark btn-fat" data-goto="pos">Barra/Granizados · Inventario + Compras + Gastos</button></div>
      <div class="col-12 col-md-3"><button class="w-100 btn btn-dark btn-fat" data-goto="socios">Socios · Cierres + Reparto</button></div>
      <div class="col-12 col-md-3"><button class="w-100 btn btn-warning btn-fat" data-goto="admin">⚙️ Administración</button></div>
    </div>
  </section>

  <!-- Mesero: Venta rápida -->
  <section id="mesero" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Ventas (Mesero)</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-6">
        <label class="form-label">POS</label>
        <select id="ventaPOS" class="form-select form-select-lg"><option>Barra</option><option>Granizados</option></select>
      </div>
      <div class="col-6">
        <label class="form-label">Producto</label>
        <select id="ventaProd" class="form-select form-select-lg"></select>
      </div>
      <div class="col-4">
        <label class="form-label">Cant.</label>
        <input id="ventaCant" type="number" min="1" value="1" class="form-control form-control-lg">
      </div>
      <div class="col-4">
        <label class="form-label">Pago</label>
        <select id="ventaPago" class="form-select form-select-lg">
          <option>Efectivo</option>
          <option>Transferencia</option>
          <option>Mixto</option>
        </select>
      </div>
      <div class="col-4">
        <label class="form-label">Notas</label>
        <input id="ventaNotas" class="form-control form-control-lg" placeholder="Mesa/promo">
      </div>

      <!-- Campos para pago Mixto -->
      <div id="mixtoFields" class="col-12 mixto-fields">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Efectivo ($)</label>
            <input id="ventaEfectivo" type="number" min="0" value="0" class="form-control form-control-lg">
          </div>
          <div class="col-6">
            <label class="form-label">Transferencia ($)</label>
            <input id="ventaTransferencia" type="number" min="0" value="0" class="form-control form-control-lg">
          </div>
          <div class="col-12">
            <small class="text-muted">Total a pagar: <span id="totalAPagar">$0</span></small>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="muted-hint">Los <b>descuentos a socios</b> regístralos en POS → Gastos (tipo <i>DescuentoSocio</i>). El <b>descuadre</b> se calcula en el cierre diario con efectivo contado.</div>
      </div>

      <div class="col-12 d-grid">
        <button id="btnAddVenta" class="btn btn-success btn-fat mt-2">Agregar venta</button>
      </div>
    </div>
    <div class="table-responsive mt-3">
      <table class="table table-sm" id="tblVentas">
        <thead>
          <tr>
            <th>Fecha</th><th>Hora</th><th>POS</th><th>Producto</th><th>Cant</th><th>Pago</th><th>Total</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- POS -->
  <section id="pos" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Inventario · Compras · Gastos</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-12 col-lg-6 tile">
        <h6>Inventario del día</h6>
        <div class="row g-2">
          <div class="col-6"><label class="form-label">POS</label><select id="invPOS" class="form-select"><option>Barra</option><option>Granizados</option></select></div>
          <div class="col-6 d-grid"><button id="btnCargarConteo" class="btn btn-outline-dark mt-4">Cargar inventario</button></div>
          <div class="col-12"><div id="inventarioContainer"></div></div>
          <div class="col-12 d-grid"><button id="btnGuardarInventario" class="btn btn-dark">Guardar cambios inventario</button></div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Compras</h6>
          <div class="row g-2">
            <div class="col-6"><label class="form-label">Producto</label><select id="compraProd" class="form-select"></select></div>
            <div class="col-3"><label class="form-label">Cant</label><input id="compraCant" type="number" min="1" value="1" class="form-control"/></div>
            <div class="col-3"><label class="form-label">PU</label><input id="compraPU" type="number" min="0" value="0" class="form-control"/></div>
            <div class="col-12"><label class="form-label">Factura (foto)</label><input id="compraFile" type="file" accept="image/*" class="form-control"/></div>
            <div class="col-12"><input id="compraNotas" class="form-control" placeholder="Notas"/></div>
            <div class="col-12 d-grid"><button id="btnAddCompra" class="btn btn-primary">Agregar compra</button></div>
          </div>
        </div>
        
        <div class="tile mt-3">
          <h6>Gastos y Nómina</h6>
          <div class="row g-2">
            <div class="col-4"><select id="gastoTipo" class="form-select"><option value="Gasto">Gasto</option><option value="Nomina">Nómina</option><option value="DescuentoSocio">DescuentoSocio</option></select></div>
            <div class="col-4"><input id="gastoConcepto" class="form-control" placeholder="Concepto"/></div>
            <div class="col-4"><input id="gastoValor" type="number" min="0" class="form-control" placeholder="Valor"/></div>
            <div class="col-6"><input id="gastoAtrib" class="form-control" placeholder="Socio/Persona"/></div>
            <div class="col-6"><input id="gastoNotas" class="form-control" placeholder="Notas"/></div>
            <div class="col-12 d-grid"><button id="btnAddGasto" class="btn btn-warning">Agregar gasto</button></div>
          </div>
          
          <!-- Sección de nómina del día -->
          <div class="mt-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
            <h6>Nómina rápida del día</h6>
            <div class="row g-2">
              <div class="col-12">
                <button id="btnCargarEmpleados" class="btn btn-sm btn-outline-primary">Cargar empleados</button>
                <button id="btnPagarNomina" class="btn btn-sm btn-success" style="display:none">Registrar nómina del día</button>
              </div>
              <div class="col-12">
                <div id="nominaContainer"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Administración -->
  <section id="admin" class="tile mt-3 admin-section" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">⚙️ Administración</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    
    <div class="row g-3 mt-2">
      <!-- Gestión de Productos -->
      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Gestión de Productos</h6>
          <div class="row g-2 mb-3">
            <div class="col-6"><input id="prodSKU" class="form-control form-control-sm" placeholder="SKU (ej: BAR-001)"/></div>
            <div class="col-6"><input id="prodName" class="form-control form-control-sm" placeholder="Nombre producto"/></div>
            <div class="col-4"><input id="prodPrice" type="number" class="form-control form-control-sm" placeholder="Precio"/></div>
            <div class="col-4"><select id="prodPOS" class="form-select form-select-sm"><option>Barra</option><option>Granizados</option></select></div>
            <div class="col-4"><input id="prodVasos" type="number" min="0" value="0" class="form-control form-control-sm" placeholder="Vasos"/></div>
            <div class="col-12 d-grid"><button id="btnAddProduct" class="btn btn-primary btn-sm">Agregar Producto</button></div>
          </div>
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm" id="tblProducts">
              <thead class="sticky-top bg-white">
                <tr><th>SKU</th><th>Nombre</th><th>Precio</th><th>POS</th><th>Vasos</th><th>Acciones</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Gestión de Empleados -->
      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Gestión de Empleados</h6>
          <div class="row g-2 mb-3">
            <div class="col-6"><input id="empName" class="form-control form-control-sm" placeholder="Nombre completo"/></div>
            <div class="col-6"><input id="empRole" class="form-control form-control-sm" placeholder="Cargo"/></div>
            <div class="col-12"><input id="empSalary" type="number" class="form-control form-control-sm" placeholder="Salario diario"/></div>
            <div class="col-12 d-grid"><button id="btnAddEmployee" class="btn btn-success btn-sm">Agregar Empleado</button></div>
          </div>
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm" id="tblEmployees">
              <thead class="sticky-top bg-white">
                <tr><th>Nombre</th><th>Cargo</th><th>Salario/día</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Socios -->
  <section id="socios" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Cierres + Reparto</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-12 tile">
        <h6>Cierre diario</h6>
        <div class="d-flex flex-wrap gap-2">
          <input type="date" id="fechaDia" class="form-control" style="max-width:200px">
          <button id="btnCierreDia" class="btn btn-dark">Generar</button>
          <div class="vr"></div>
          <input type="number" id="efContadoBarra" class="form-control" placeholder="Efectivo contado Barra" style="max-width:220px">
          <input type="number" id="efContadoGrz" class="form-control" placeholder="Efectivo contado Granizados" style="max-width:260px">
          <button id="btnRegDescuadres" class="btn btn-outline-danger">Registrar descuadres como deudas</button>
        </div>
        <div id="cierreDia" class="mt-3"></div>
      </div>
      <div class="col-12 tile mt-3">
        <h6>Cierre semanal + reparto</h6>
        <div class="d-flex gap-2">
          <input type="date" id="semDesde" class="form-control" style="max-width:200px">
          <input type="date" id="semHasta" class="form-control" style="max-width:200px">
          <button id="btnCierreSem" class="btn btn-dark">Generar</button>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-12 col-lg-6"><div id="cierreSemResumen"></div></div>
          <div class="col-12 col-lg-6"><div id="cierreReparto"></div></div>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="sticky-footer d-flex justify-content-between align-items-center">
  <div class="small text-muted">Instálala como PWA (Agregar a pantalla de inicio). Guarda en Supabase.</div>
  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-secondary" data-goto="home">Inicio</button>
  </div>
</div>

<div id="health" style="position:fixed;right:8px;bottom:8px;font:12px system-ui;background:#111;color:#fff;padding:6px 10px;border-radius:8px;opacity:.9;z-index:9999">Cargando…</div>
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const ok = (t)=>{ const el=document.getElementById('health'); el.textContent=t; el.style.background='#198754'; };
  const bad = (t)=>{ const el=document.getElementById('health'); el.textContent=t; el.style.background='#dc3545'; };
  try{
    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const { error } = await supabase.from('products').select('id', { count: 'exact', head: true });
    if(error) bad('Supabase: ERROR'); else ok('Supabase: OK');
    setTimeout(()=>document.getElementById('health').remove(), 2500);
  }catch(e){ bad('JS error'); }
</script>
  
<script type="module">
  import { 
    supabase, q, money, 
    getProducts, addProduct, updateProduct, deleteProduct,
    getEmployees, addEmployee,
    addSale, addPurchase, addExpense, addPayrollDay,
    upsertCounts, getCounts,
    fetchDayClose, fetchRangeClose, deleteSale 
  } from './supabaseClient.js?v=5';

  // ==== Fecha local consistente + getter del selector ====
  const localISODate = () => {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  };
  const getSelectedDate = () => document.getElementById('appDate').value || localISODate();
  document.getElementById('appDate').value = localISODate();
  document.getElementById('appDate').addEventListener('change', () => {
    renderVentas();
  });

  const goto = (id)=>['home','mesero','pos','socios','admin'].forEach(s=>document.getElementById(s).hidden=(s!==id));
  document.querySelectorAll('[data-goto]').forEach(b=>b.onclick=()=>goto(b.dataset.goto));
  goto('home');

  // ============ PRODUCTOS ============
  let products = [];
  let employees = [];

  async function loadProducts(){
    try {
      products = await getProducts();
      rebuildSelects();
      renderProductsTable();
    } catch(e) {
      console.error('Error loading products:', e);
      alert('Error cargando catálogo');
    }
  }

  function rebuildSelects(){
    const pos = document.getElementById('ventaPOS').value;
    document.getElementById('ventaProd').innerHTML = products.filter(p=>p.pos===pos && p.type==='producto').map(p=>`<option value="${p.id}">${p.name} (${p.sku})</option>`).join('');
    document.getElementById('compraProd').innerHTML = products.map(p=>`<option value="${p.id}">${p.name} (${p.sku})</option>`).join('');
  }

  function renderProductsTable() {
    const tbody = document.querySelector('#tblProducts tbody');
    tbody.innerHTML = '';
    products.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${money(p.price)}</td>
        <td><span class="pos-pill pos-${p.pos}">${p.pos}</span></td>
        <td>${p.vasos_per_unit || 0}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${p.id}')">Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeProduct('${p.id}')">Borrar</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // Agregar producto
  document.getElementById('btnAddProduct').addEventListener('click', async () => {
    const sku = document.getElementById('prodSKU').value.trim();
    const name = document.getElementById('prodName').value.trim();
    const price = +document.getElementById('prodPrice').value || 0;
    const pos = document.getElementById('prodPOS').value;
    const vasos_per_unit = +document.getElementById('prodVasos').value || 0;

    if (!sku || !name || price <= 0) {
      return alert('Complete SKU, nombre y precio válido');
    }

    try {
      await addProduct({ sku, name, price, pos, vasos_per_unit });
      alert('Producto agregado');
      
      // Limpiar form
      document.getElementById('prodSKU').value = '';
      document.getElementById('prodName').value = '';
      document.getElementById('prodPrice').value = '';
      document.getElementById('prodVasos').value = '0';
      
      await loadProducts();
    } catch(e) {
      console.error(e);
      alert('Error agregando producto: ' + e.message);
    }
  });

  // Funciones globales para editar/borrar productos
  window.editProduct = async (id) => {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    const newName = prompt('Nuevo nombre:', product.name);
    const newPrice = prompt('Nuevo precio:', product.price);
    
    if (newName && newPrice && +newPrice > 0) {
      try {
        await updateProduct(id, { name: newName.trim(), price: +newPrice });
        alert('Producto actualizado');
        await loadProducts();
      } catch(e) {
        alert('Error actualizando: ' + e.message);
      }
    }
  };

  window.removeProduct = async (id) => {
    if (!confirm('¿Desactivar este producto?')) return;
    try {
      await deleteProduct(id);
      alert('Producto desactivado');
      await loadProducts();
    } catch(e) {
      alert('Error desactivando: ' + e.message);
    }
  };

  // ============ EMPLEADOS ============
  async function loadEmployees(){
    try {
      employees = await getEmployees();
      renderEmployeesTable();
    } catch(e) {
      console.error('Error loading employees:', e);
    }
  }

  function renderEmployeesTable() {
    const tbody = document.querySelector('#tblEmployees tbody');
    tbody.innerHTML = '';
    employees.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.name}</td>
        <td>${e.role}</td>
        <td>${money(e.daily_salary)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Agregar empleado
  document.getElementById('btnAddEmployee').addEventListener('click', async () => {
    const name = document.getElementById('empName').value.trim();
    const role = document.getElementById('empRole').value.trim();
    const daily_salary = +document.getElementById('empSalary').value || 0;

    if (!name || !role || daily_salary <= 0) {
      return alert('Complete nombre, cargo y salario válido');
    }

    try {
      await addEmployee({ name, role, daily_salary });
      alert('Empleado agregado');
      
      // Limpiar form
      document.getElementById('empName').value = '';
      document.getElementById('empRole').value = '';
      document.getElementById('empSalary').value = '';
      
      await loadEmployees();
    } catch(e) {
      alert('Error agregando empleado: ' + e.message);
    }
  });

  // ============ MANEJO DE PAGO MIXTO ============
  function updateTotalAPagar() {
    const productId = document.getElementById('ventaProd').value;
    const qty = +document.getElementById('ventaCant').value || 1;
    const product = products.find(p => p.id === productId);
    const total = product ? product.price * qty : 0;
    document.getElementById('totalAPagar').textContent = money(total);
    return total;
  }

  // Mostrar/ocultar campos mixto
  document.getElementById('ventaPago').addEventListener('change', function() {
    const payMethod = this.value;
    const mixtoFields = document.getElementById('mixtoFields');
    
    if (payMethod === 'Mixto') {
      mixtoFields.classList.add('show');
      updateTotalAPagar();
    } else {
      mixtoFields.classList.remove('show');
      document.getElementById('ventaEfectivo').value = 0;
      document.getElementById('ventaTransferencia').value = 0;
    }
  });

  // Actualizar total cuando cambie producto o cantidad
  document.getElementById('ventaProd').addEventListener('change', updateTotalAPagar);
  document.getElementById('ventaCant').addEventListener('input', updateTotalAPagar);

  // Validar suma en tiempo real para pago mixto
  function validateMixto() {
    const efectivo = +document.getElementById('ventaEfectivo').value || 0;
    const transferencia = +document.getElementById('ventaTransferencia').value || 0;
    const total = updateTotalAPagar();
    
    const suma = efectivo + transferencia;
    const btnAdd = document.getElementById('btnAddVenta');
    
    if (document.getElementById('ventaPago').value === 'Mixto') {
      if (suma === total) {
        btnAdd.disabled = false;
        btnAdd.textContent = editingSale ? 'Guardar cambios' : 'Agregar venta';
        btnAdd.className = 'btn btn-success btn-fat mt-2';
      } else {
        btnAdd.disabled = true;
        btnAdd.textContent = `Falta ${money(total - suma)} (Total: ${money(total)})`;
        btnAdd.className = 'btn btn-outline-danger btn-fat mt-2';
      }
    } else {
      btnAdd.disabled = false;
      btnAdd.textContent = editingSale ? 'Guardar cambios' : 'Agregar venta';
      btnAdd.className = 'btn btn-success btn-fat mt-2';
    }
  }

  document.getElementById('ventaEfectivo').addEventListener('input', validateMixto);
  document.getElementById('ventaTransferencia').addEventListener('input', validateMixto);
  document.getElementById('ventaPOS').addEventListener('change', rebuildSelects);

  // Estado edición
  let editingSale = null;

  // Add / Update sale
  document.getElementById('btnAddVenta').addEventListener('click', async()=>{
    const pos = document.getElementById('ventaPOS').value;
    const product_id = document.getElementById('ventaProd').value;
    const qty = +document.getElementById('ventaCant').value || 1;
    const pay_method = document.getElementById('ventaPago').value;
    const notes = document.getElementById('ventaNotas').value.trim();
    const date = getSelectedDate();
    const time = new Date().toTimeString().slice(0,8);
    
    // Obtener cash_amount y transfer_amount según método de pago
    let cash_amount = 0;
    let transfer_amount = 0;
    
    if (pay_method === 'Mixto') {
      cash_amount = +document.getElementById('ventaEfectivo').value || 0;
      transfer_amount = +document.getElementById('ventaTransferencia').value || 0;
    }
    
    try{
      if(editingSale){
        await deleteSale(editingSale.id);
        await addSale({
          date,
          time: editingSale.time || time,
          pos,
          product_id,
          qty,
          pay_method,
          cash_amount,
          transfer_amount,
          notes
        });
        editingSale = null;
        document.getElementById('btnAddVenta').textContent = 'Agregar venta';
        alert('Venta actualizada');
      }else{
        await addSale({
          date,
          time,
          pos,
          product_id,
          qty,
          pay_method,
          cash_amount,
          transfer_amount,
          notes
        });
        alert('Venta registrada');
      }
      
      // Limpiar formulario
      document.getElementById('ventaCant').value = 1;
      document.getElementById('ventaNotas').value = '';
      document.getElementById('ventaEfectivo').value = 0;
      document.getElementById('ventaTransferencia').value = 0;
      document.getElementById('ventaPago').value = 'Efectivo';
      document.getElementById('mixtoFields').classList.remove('show');
      
      await renderVentas();
    }catch(e){ 
      console.error(e); 
      alert('Error guardando venta: ' + e.message); 
    }
  });

  async function renderVentas(){
    const d = getSelectedDate();
    const { data, error } = await supabase
      .from('sales')
      .select('*, products(name,price,pos)')
      .eq('date', d)
      .order('time');
    
    if (error) {
      console.error('Error loading sales:', error);
      return;
    }
    
    const tb = document.querySelector('#tblVentas tbody'); 
    tb.innerHTML='';
    
    (data||[]).forEach(v=>{
      const total = v.cash_amount + v.transfer_amount;
      let pagoDisplay = v.pay_method;
      
      // Mostrar desglose si es mixto
      if (v.pay_method === 'Mixto') {
        pagoDisplay = `Mixto (E:${money(v.cash_amount)} T:${money(v.transfer_amount)})`;
      }
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${v.date}</td>
        <td>${v.time}</td>
        <td><span class="pos-pill pos-${v.pos}">${v.pos}</span></td>
        <td>${v.products?.name||''}</td>
        <td>${v.qty}</td>
        <td>${pagoDisplay}</td>
        <td>${money(total)}</td>
        <td>
          <span class="text-primary me-2" style="cursor:pointer" data-edit='${JSON.stringify({
            id:v.id, 
            date:v.date, 
            time:v.time, 
            pos:v.pos, 
            product_id:v.product_id, 
            qty:v.qty, 
            pay_method:v.pay_method, 
            cash_amount: v.cash_amount,
            transfer_amount: v.transfer_amount,
            notes:v.notes||''
          }).replace(/"/g,'&quot;')}'>Editar</span>
          <span class="text-danger" style="cursor:pointer" data-del="${v.id}">Borrar</span>
        </td>`;
      tb.appendChild(tr);
    });

    // Borrar (CON BUG FIX - actualiza inmediatamente la UI)
    tb.querySelectorAll('[data-del]').forEach(el=>{
      el.onclick = async () => {
        if(!confirm('¿Borrar venta? Esto revierte el inventario.')) return;
        try { 
          await deleteSale(el.dataset.del); 
          await renderVentas(); 
        }
        catch(e){ 
          console.error(e); 
          alert('Error borrando: ' + e.message); 
        }
      };
    });
    
    // Editar
    tb.querySelectorAll('[data-edit]').forEach(el=>{
      el.onclick = () => {
        const v = JSON.parse(el.dataset.edit.replace(/&quot;/g,'"'));
        editingSale = v;
        document.getElementById('ventaPOS').value = v.pos;
        rebuildSelects();
        document.getElementById('ventaProd').value = v.product_id;
        document.getElementById('ventaCant').value = v.qty;
        document.getElementById('ventaPago').value = v.pay_method;
        document.getElementById('ventaNotas').value = v.notes || '';
        document.getElementById('appDate').value = v.date;
        
        // Configurar campos mixto si es necesario
        if (v.pay_method === 'Mixto') {
          document.getElementById('mixtoFields').classList.add('show');
          document.getElementById('ventaEfectivo').value = v.cash_amount || 0;
          document.getElementById('ventaTransferencia').value = v.transfer_amount || 0;
        } else {
          document.getElementById('mixtoFields').classList.remove('show');
        }
        
        document.getElementById('btnAddVenta').textContent = 'Guardar cambios';
        goto('mesero');
      };
    });
  }

  // ============ INVENTARIO MEJORADO ============
  async function cargarInventario() {
    const pos = document.getElementById('invPOS').value;
    const date = getSelectedDate();
    
    try {
      // Obtener conteos existentes
      const existingCounts = await getCounts(date, pos);
      
      // Obtener productos del POS
      const posProducts = products.filter(p => p.pos === pos && p.type === 'producto');
      
      let html = `
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr><th>SKU</th><th>Producto</th><th>Inicial</th><th>Final</th></tr>
            </thead>
            <tbody>`;
      
      posProducts.forEach(product => {
        const existing = existingCounts.find(c => c.product_id === product.id);
        const initial = existing?.initial_qty || 0;
        const final = existing?.final_qty || 0;
        
        html += `
          <tr>
            <td>${product.sku}</td>
            <td>${product.name}</td>
            <td><input type="number" class="editable-count" value="${initial}" data-pid="${product.id}" data-type="initial" min="0"></td>
            <td><input type="number" class="editable-count" value="${final}" data-pid="${product.id}" data-type="final" min="0"></td>
          </tr>`;
      });
      
      html += `</tbody></table></div>`;
      document.getElementById('inventarioContainer').innerHTML = html;
      
    } catch(e) {
      console.error('Error cargando inventario:', e);
      alert('Error cargando inventario');
    }
  }

  document.getElementById('btnCargarConteo').addEventListener('click', cargarInventario);

  // Guardar inventario
  document.getElementById('btnGuardarInventario').addEventListener('click', async () => {
    const pos = document.getElementById('invPOS').value;
    const date = getSelectedDate();
    
    const rows = [];
    document.querySelectorAll('#inventarioContainer input[data-pid]').forEach(input => {
      const pid = input.dataset.pid;
      const type = input.dataset.type;
      const value = +input.value || 0;
      
      let existing = rows.find(r => r.product_id === pid);
      if (!existing) {
        existing = { product_id: pid, initial_qty: 0, final_qty: 0 };
        rows.push(existing);
      }
      
      if (type === 'initial') existing.initial_qty = value;
      if (type === 'final') existing.final_qty = value;
    });
    
    try {
      await upsertCounts({ date, pos, rows });
      alert('Inventario guardado');
    } catch(e) {
      console.error('Error guardando inventario:', e);
      alert('Error guardando inventario');
    }
  });

  // ============ NÓMINA ============
  let selectedEmployees = [];

  document.getElementById('btnCargarEmpleados').addEventListener('click', () => {
    if (employees.length === 0) {
      return alert('No hay empleados registrados. Ve a Administración para agregar empleados.');
    }
    
    let html = '<div class="row g-2">';
    employees.forEach(emp => {
      html += `
        <div class="col-12">
          <div class="form-check d-flex justify-content-between align-items-center p-2" style="background: white; border: 1px solid #dee2e6; border-radius: 4px;">
            <div>
              <input class="form-check-input" type="checkbox" value="${emp.id}" id="emp${emp.id}">
              <label class="form-check-label" for="emp${emp.id}">
                <strong>${emp.name}</strong> - ${emp.role}
              </label>
            </div>
            <span class="badge bg-primary">${money(emp.daily_salary)}</span>
          </div>
        </div>`;
    });
    html += '</div>';
    
    document.getElementById('nominaContainer').innerHTML = html;
    document.getElementById('btnPagarNomina').style.display = 'block';
  });

  document.getElementById('btnPagarNomina').addEventListener('click', async () => {
    const checkedInputs = document.querySelectorAll('#nominaContainer input[type="checkbox"]:checked');
    
    if (checkedInputs.length === 0) {
      return alert('Selecciona al menos un empleado');
    }
    
    const date = getSelectedDate();
    const selectedEmps = Array.from(checkedInputs).map(input => {
      const empId = input.value;
      const emp = employees.find(e => e.id == empId);
      return {
        name: emp.name,
        role: emp.role,
        salary: emp.daily_salary
      };
    });
    
    try {
      await addPayrollDay({ date, employees: selectedEmps });
      alert(`Nómina registrada para ${selectedEmps.length} empleados`);
      
      // Limpiar selección
      document.getElementById('nominaContainer').innerHTML = '';
      document.getElementById('btnPagarNomina').style.display = 'none';
      
    } catch(e) {
      console.error('Error registrando nómina:', e);
      alert('Error registrando nómina: ' + e.message);
    }
  });

  // Purchases
  document.getElementById('btnAddCompra').addEventListener('click', async()=>{
    const product_id = document.getElementById('compraProd').value;
    const qty = +document.getElementById('compraCant').value||0;
    const unit_cost = +document.getElementById('compraPU').value||0;
    const notes = document.getElementById('compraNotas').value.trim();
    const file = document.getElementById('compraFile').files[0]||null;
    const date = getSelectedDate();
    const pos = products.find(p=>p.id===product_id)?.pos || 'Barra';
    try{
      await addPurchase({date,pos,product_id,qty,unit_cost,notes,file});
      alert('Compra registrada');
      document.getElementById('compraCant').value=1; document.getElementById('compraPU').value=0; document.getElementById('compraNotas').value=''; document.getElementById('compraFile').value='';
    }catch(e){ console.error(e); alert('Error guardando compra'); }
  });

  // Expenses
  document.getElementById('btnAddGasto').addEventListener('click', async()=>{
    const type = document.getElementById('gastoTipo').value;
    const concept = document.getElementById('gastoConcepto').value.trim();
    const amount = +document.getElementById('gastoValor').value||0;
    const attributed_to = document.getElementById('gastoAtrib').value.trim();
    const notes = document.getElementById('gastoNotas').value.trim();
    const date = getSelectedDate();
    try{ await addExpense({date,type,concept,amount,attributed_to,notes}); alert('Gasto registrado'); }catch(e){ alert('Error guardando gasto'); }
  });

  // ===== Cierres =====
  let cacheCierreDia = null;
  document.getElementById('btnCierreDia').addEventListener('click', async()=>{
    const f = document.getElementById('fechaDia').value || getSelectedDate();
    const { sales, expenses } = await fetchDayClose(f);
    const porPOS = (pos) => (sales||[]).filter(x=>x.pos===pos).reduce((acc,cur)=>{
      acc.total += (cur.cash_amount + cur.transfer_amount); 
      acc.ef += cur.cash_amount;
      acc.tr += cur.transfer_amount;
      return acc;
    }, {total:0, ef:0, tr:0});
    const barra = porPOS('Barra'); const grz = porPOS('Granizados');

    let gto=0, nom=0, dss=0;
    (expenses||[]).forEach(e=>{ if(e.type==='Gasto') gto+=e.amount; else if(e.type==='Nomina') nom+=e.amount; else if(e.type==='DescuentoSocio') dss+=e.amount; });

    const efBarraEsp = barra.ef;
    const efGrzEsp = grz.ef;
    cacheCierreDia = { fecha:f, efBarraEsp, efGrzEsp };

    document.getElementById('cierreDia').innerHTML = `
      <div class="row g-2">
        <div class="col-12 col-lg-6"><div class="tile"><h6>Barra</h6><div>Total: <b>${money(barra.total)}</b></div><div>Efectivo esperado: <b>${money(efBarraEsp)}</b> · Transf: ${money(barra.tr)}</div></div></div>
        <div class="col-12 col-lg-6"><div class="tile"><h6>Granizados</h6><div>Total: <b>${money(grz.total)}</b></div><div>Efectivo esperado: <b>${money(efGrzEsp)}</b> · Transf: ${money(grz.tr)}</div></div></div>
      </div>
      <div class="mt-2 d-flex flex-wrap gap-2 align-items-end">
        <div><label class="form-label">Efectivo contado Barra</label><input type="number" id="efContadoBarra" class="form-control" style="max-width:220px"></div>
        <div><label class="form-label">Efectivo contado Granizados</label><input type="number" id="efContadoGrz" class="form-control" style="max-width:260px"></div>
        <button id="btnRegDescuadres" class="btn btn-outline-danger">Registrar descuadres como deudas</button>
      </div>`;
  });

  // Registrar descuadres como deudas
  document.addEventListener('click', async (e)=>{
    if(e.target && e.target.id==='btnRegDescuadres'){
      if(!cacheCierreDia) return alert('Genera el cierre diario primero.');
      const contBarra = +document.getElementById('efContadoBarra').value||0;
      const contGrz = +document.getElementById('efContadoGrz').value||0;
      const diffBarra = Math.max(0, cacheCierreDia.efBarraEsp - contBarra);
      const diffGrz = Math.max(0, cacheCierreDia.efGrzEsp - contGrz);
      if(diffBarra===0 && diffGrz===0) return alert('Sin descuadres.');

      const { data: mgrs } = await supabase.from('pos_managers').select('*');
      const encBarra = (mgrs||[]).find(m=>m.pos==='Barra')?.manager_name || 'Encargado Barra';
      const encGrz = (mgrs||[]).find(m=>m.pos==='Granizados')?.manager_name || 'Encargado Granizados';

      const rows = [];
      if(diffBarra>0) rows.push({date: cacheCierreDia.fecha, person: encBarra, reason:`Descuadre Barra`, amount: diffBarra, balance: diffBarra});
      if(diffGrz>0) rows.push({date: cacheCierreDia.fecha, person: encGrz, reason:`Descuadre Granizados`, amount: diffGrz, balance: diffGrz});

      const { error } = await supabase.from('debts').insert(rows);
      if(error){ console.error(error); return alert('Error registrando deudas'); }
      alert('Descuadres registrados.');
    }
  });

  document.getElementById('btnCierreSem').addEventListener('click', async()=>{
    const d = document.getElementById('semDesde').value, h = document.getElementById('semHasta').value;
    if(!d || !h) return alert('Selecciona fechas');
    const { sales, expenses, counts, managers, partners } = await fetchRangeClose(d,h);

    let total=0, ef=0, tr=0;
    (sales||[]).forEach(s=>{
      total += (s.cash_amount + s.transfer_amount);
      ef += s.cash_amount;
      tr += s.transfer_amount;
    });

    let gto=0, nom=0, dss=0; const expBySoc = {};
    (expenses||[]).forEach(e=>{
      if(e.type==='Gasto') gto+=e.amount; else if(e.type==='Nomina') nom+=e.amount; else if(e.type==='DescuentoSocio') dss+=e.amount;
      if(e.attributed_to){ expBySoc[e.attributed_to] = (expBySoc[e.attributed_to]||0) + e.amount; }
    });

    const utilidad = total - (gto+nom+dss);

    const repRows = (partners||[]).map(p=>{
      const base = utilidad * (Number(p.participation_pct||0)/100);
      const ajustes = -(expBySoc[p.name]||0);
      const final = base + ajustes;
      return { name:p.name, pct: p.participation_pct, base, ajustes, final };
    });

    const { data: debts } = await supabase.from('debts').select('*').gte('date', d).lte('date', h);
    const desBarra = (debts||[]).filter(x=>/Barra/.test(x.reason)).reduce((a,b)=>a+b.amount,0);
    const desGrz = (debts||[]).filter(x=>/Granizados/.test(x.reason)).reduce((a,b)=>a+b.amount,0);

    document.getElementById('cierreSemResumen').innerHTML = `
      <div class="tile">
        <div>${d} a ${h}</div>
        <div class="mt-1">Ventas: <b>${money(total)}</b> · Efectivo: ${money(ef)} · Transf: ${money(tr)}</div>
        <div>Gastos: ${money(gto)} · Nómina: ${money(nom)} · Desc. Socios: ${money(dss)}</div>
        <div class="mt-1">Utilidad neta: <b>${money(utilidad)}</b></div>
        <div class="mt-1"><b>Deudas por descuadre</b> · Barra: ${money(desBarra)} · Granizados: ${money(desGrz)}</div>
      </div>`;

    document.getElementById('cierreReparto').innerHTML = `
      <div class="tile">
        <h6>Reparto por socio</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Socio</th><th>%</th><th>Base</th><th>Ajustes</th><th>Total</th></tr></thead>
            <tbody>
              ${repRows.map(r=>`<tr><td>${r.name}</td><td>${r.pct}%</td><td>${money(r.base)}</td><td>${money(r.ajustes)}</td><td><b>${money(r.final)}</b></td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>`;
  });

  document.getElementById('btnReset').addEventListener('click', ()=>{
    if('caches' in window){ caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))); }
    alert('Cache PWA limpiada. (Los datos viven en Supabase)');
  });

  // init
  await loadProducts();
  await loadEmployees();
  await renderVentas();

  // PWA SW register
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }
</script>
</body>
</html>