<!DOCTYPE html>
<html lang="es">
<head>
  <script src="./config.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Control Bar Â· PWA (Supabase)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./styles/main.css">
  <!-- LibrerÃ­as para exportaciÃ³n -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="./export-utils.js?v=7"></script>
  <!-- MÃ³dulos JavaScript organizados -->
  <script src="./js/ui-helpers.js"></script>
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "{{SUPABASE_URL}}";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "{{SUPABASE_ANON_KEY}}";
  </script>
</head>
<body>
<div class="app">
  <header class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="m-0">Control Bar Â· PWA</h4>
    <div class="d-flex align-items-center gap-2">
      <label class="form-label m-0">Fecha</label>
      <input id="appDate" type="date" class="form-control form-control-sm" style="min-width:150px">
      <button id="btnReset" class="btn btn-sm btn-outline-secondary">Reset local</button>
      <button id="btnResetData" class="btn btn-sm btn-outline-danger" onclick="resetAllDataConfirm()">ğŸ—‘ï¸ Reset BD</button>
      <button id="btnExportData" class="btn btn-sm btn-outline-success" onclick="exportDailyData()">ğŸ“Š Export</button>
    </div>
  </header>

  <section id="home" class="tile">
    <!-- FLUJO COMPLETO DEL NEGOCIO - GUÃA DETALLADA -->
    <div class="row g-2 mb-4">
      <div class="col-12">
        <div class="alert alert-info">
          <h6><strong>ğŸ“‹ FLUJO COMPLETO DEL CIERRE DIARIO - BAR CON 2 POS</strong></h6>
          
          <div class="row g-3 mt-2">
            <div class="col-12 col-md-6">
              <h6>ğŸŒ… <strong>INICIO DEL DÃA (8:00 AM)</strong></h6>
              <ol class="small">
                <li><strong>POS â†’ Inventario:</strong> Contar stock inicial en BARRA y GRANIZADOS por separado</li>
                <li><strong>Admin â†’ Encargados:</strong> Asignar responsables por POS para descuadres</li>
                <li><strong>Verificar productos:</strong> Que estÃ©n todos activos y con precios correctos</li>
              </ol>
              
              <h6>ğŸº <strong>DURANTE EL DÃA</strong></h6>
              <ol class="small">
                <li><strong>Ventas:</strong> Registrar cada venta especificando POS (Barra/Granizados) y mÃ©todo de pago</li>
                <li><strong>POS â†’ Compras:</strong> Registrar todas las compras con factura y POS correspondiente</li>
                <li><strong>POS â†’ Gastos:</strong> Registrar gastos operativos y descuentos a socios</li>
              </ol>
            </div>
            
            <div class="col-12 col-md-6">
              <h6>ğŸŒ™ <strong>CIERRE DEL DÃA (11:00 PM)</strong></h6>
              <ol class="small">
                <li><strong>POS â†’ Inventario Final:</strong> Contar stock restante por POS</li>
                <li><strong>Cierres â†’ Cierre Diario:</strong> 
                  <ul class="small">
                    <li>ğŸ” <strong>Inferencia automÃ¡tica:</strong> Sistema calcula ventas faltantes por diferencia de inventario</li>
                    <li>ğŸ’° <strong>Efectivo esperado:</strong> Suma todas las ventas en efectivo (registradas + inferidas)</li>
                    <li>ğŸ“Š <strong>Contar caja:</strong> Efectivo fÃ­sico por POS</li>
                    <li>âš–ï¸ <strong>Descuadres:</strong> Diferencia entre esperado vs contado â†’ se asigna al encargado</li>
                  </ul>
                </li>
                <li><strong>ValidaciÃ³n crÃ­tica:</strong> 
                  <ul class="small">
                    <li>Inicial + Compras - Final = Ventas registradas + inferidas</li>
                    <li>Efectivo contado vs esperado = Descuadre del encargado</li>
                  </ul>
                </li>
              </ol>
              
              <h6>ğŸ“… <strong>CIERRE SEMANAL (Domingos)</strong></h6>
              <ol class="small">
                <li><strong>Cierres â†’ Reparto:</strong> Utilidad = Ventas - Gastos - Compras</li>
                <li><strong>DistribuciÃ³n por %:</strong> Cada socio recibe segÃºn su participaciÃ³n (debe sumar 100%)</li>
                <li><strong>Descuentos aplicados:</strong> Se restan del reparto del socio correspondiente</li>
              </ol>
            </div>
          </div>
          
          <div class="mt-3 p-2 bg-warning text-dark rounded">
            <strong>âš ï¸ CRÃTICO:</strong> Cada POS (Barra/Granizados) maneja inventario, efectivo y descuadres por separado. 
            El sistema NO permite mezclar inventarios entre POS.
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard unificado con KPIs y acceso rÃ¡pido -->
    <div id="dashboardKPIs" class="row g-2 mb-4"></div>
    
    <!-- Panel de ventas rÃ¡pidas integrado -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-6">
        <div class="quick-action-card">
          <h6 class="mb-3">ğŸº Registrar Venta por POS</h6>
          <div class="row g-2">
            <div class="col-6">
              <select id="ventaPOS" class="form-select"><option>Barra</option><option>Granizados</option></select>
            </div>
            <div class="col-6">
              <select id="ventaProd" class="form-select"></select>
            </div>
            <div class="col-4">
              <input id="ventaCant" type="number" min="1" value="1" class="form-control" placeholder="Cant.">
            </div>
            <div class="col-4">
              <select id="ventaPago" class="form-select">
                <option>Efectivo</option>
                <option>Transferencia</option>
                <option>Mixto</option>
              </select>
            </div>
            <div class="col-4">
              <button id="btnAddVenta" class="btn btn-success w-100">Vender</button>
            </div>
            <div class="col-12">
              <input id="ventaNotas" class="form-control form-control-sm" placeholder="Cliente/observaciÃ³n (opcional)">
            </div>
            <!-- Campos mixto -->
            <div id="mixtoFields" class="col-12 mixto-fields">
              <div class="row g-2">
                <div class="col-6">
                  <input id="ventaEfectivo" type="number" min="0" value="0" class="form-control" placeholder="Efectivo $">
                </div>
                <div class="col-6">
                  <input id="ventaTransferencia" type="number" min="0" value="0" class="form-control" placeholder="Transferencia $">
                </div>
                <div class="col-12">
                  <small class="text-muted">Total a pagar: <span id="totalAPagar">$0</span></small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12 col-lg-6">
        <div class="quick-action-card">
          <h6 class="mb-3">ğŸ“Š Actividad del DÃ­a</h6>
          <div id="activitySummary" class="activity-summary">
            <div class="row g-2 text-center">
              <div class="col-6">
                <div class="metric-mini">
                  <div id="ventasCount" class="metric-value">0</div>
                  <div class="metric-label">Ventas</div>
                </div>
              </div>
              <div class="col-6">
                <div class="metric-mini">
                  <div id="comprasCount" class="metric-value">0</div>
                  <div class="metric-label">Compras</div>
                </div>
              </div>
            </div>
            <div id="lastActivity" class="mt-2 text-muted small">Ãšltima actividad...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- NavegaciÃ³n simplificada -->
    <div class="row g-2">
      <div class="col-12 col-md-4">
        <button class="w-100 btn btn-primary btn-fat" data-goto="pos">
          ğŸ“¦ POS Â· Barra/Granizados
          <small class="d-block">Inventario â€¢ Compras â€¢ Gastos</small>
        </button>
      </div>
      <div class="col-12 col-md-4">
        <button class="w-100 btn btn-success btn-fat" data-goto="socios">
          ğŸ’° Socios Â· Cierres
          <small class="d-block">Descuadres â€¢ Repartos â€¢ Informes</small>
        </button>
      </div>
      <div class="col-12 col-md-4">
        <button class="w-100 btn btn-warning btn-fat" data-goto="admin">
          âš™ï¸ AdministraciÃ³n
          <small class="d-block">Productos â€¢ Empleados â€¢ Config</small>
        </button>
      </div>
    </div>
  </section>


  <!-- POS: Inventario, Compras y Gastos -->
  <section id="pos" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Inventario Â· Compras Â· Gastos</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-12 col-lg-6 tile">
        <h6>Inventario del dÃ­a</h6>
        <div class="row g-2">
          <div class="col-6"><label class="form-label">POS</label><select id="invPOS" class="form-select"><option>Barra</option><option>Granizados</option></select></div>
          <div class="col-6 d-grid"><button id="btnCargarConteo" class="btn btn-outline-dark mt-4">Cargar inventario</button></div>
          <div class="col-12"><div id="inventarioContainer"></div></div>
          <div class="col-12 d-grid"><button id="btnGuardarInventario" class="btn btn-dark">Guardar cambios inventario</button></div>
          
          <!-- Mostrar compras del dÃ­a -->
          <div class="col-12 mt-3">
            <h6>ğŸ“¦ Compras del dÃ­a</h6>
            <div id="comprasDelDia"></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>Compras</h6>
          <div class="row g-2">
            <div class="col-6"><label class="form-label">Producto</label><select id="compraProd" class="form-select"></select></div>
            <div class="col-3"><label class="form-label">Cant</label><input id="compraCant" type="number" min="1" value="1" class="form-control"/></div>
            <div class="col-3"><label class="form-label">PU</label><input id="compraPU" type="number" min="0" value="0" class="form-control"/></div>
            <div class="col-12"><label class="form-label">Factura (foto)</label><input id="compraFile" type="file" accept="image/*" class="form-control"/></div>
            <div class="col-12"><input id="compraNotas" class="form-control" placeholder="Notas"/></div>
            <div class="col-12 d-grid"><button id="btnAddCompra" class="btn btn-primary">Agregar compra</button></div>
          </div>
        </div>
        
        <div class="tile mt-3">
          <h6>Gastos y NÃ³mina</h6>
          <div class="row g-2">
            <div class="col-4"><select id="gastoTipo" class="form-select"><option value="Gasto">Gasto</option><option value="Nomina">NÃ³mina</option><option value="DescuentoSocio">DescuentoSocio</option></select></div>
            <div class="col-4"><input id="gastoConcepto" class="form-control" placeholder="Concepto"/></div>
            <div class="col-4"><input id="gastoValor" type="number" min="0" class="form-control" placeholder="Valor"/></div>
            <div class="col-6">
              <input id="gastoAtrib" class="form-control" placeholder="Socio/Persona"/>
              <select id="gastoSocioSelect" class="form-select" style="display:none">
                <option value="">Seleccionar socio...</option>
              </select>
            </div>
            <div class="col-6"><input id="gastoNotas" class="form-control" placeholder="Notas"/></div>
            <div class="col-12 d-grid"><button id="btnAddGasto" class="btn btn-warning">Agregar gasto</button></div>
          </div>
          
          <!-- Mostrar gastos del dÃ­a -->
          <div class="col-12 mt-3">
            <h6>ğŸ’¸ Gastos del dÃ­a</h6>
            <div id="gastosDelDia"></div>
          </div>
          
          <!-- SecciÃ³n de nÃ³mina del dÃ­a -->
          <div class="mt-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
            <h6>NÃ³mina rÃ¡pida del dÃ­a</h6>
            <div class="row g-2">
              <div class="col-12">
                <button id="btnCargarEmpleados" class="btn btn-sm btn-outline-primary">Cargar empleados</button>
                <button id="btnPagarNomina" class="btn btn-sm btn-success" style="display:none">Registrar nÃ³mina del dÃ­a</button>
              </div>
              <div class="col-12">
                <div id="nominaContainer"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- AdministraciÃ³n -->
  <section id="admin" class="tile mt-3 admin-section" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">âš™ï¸ AdministraciÃ³n</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    
    <div class="row g-3 mt-2">
      <!-- GestiÃ³n de Productos -->
      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>GestiÃ³n de Productos</h6>
          <div class="row g-2 mb-3">
            <div class="col-6"><input id="prodSKU" class="form-control form-control-sm" placeholder="SKU (ej: BAR-001)"/></div>
            <div class="col-6"><input id="prodName" class="form-control form-control-sm" placeholder="Nombre producto"/></div>
            <div class="col-4"><input id="prodPrice" type="number" class="form-control form-control-sm" placeholder="Precio"/></div>
            <div class="col-4"><select id="prodPOS" class="form-select form-select-sm"><option>Barra</option><option>Granizados</option></select></div>
            <div class="col-4"><input id="prodVasos" type="number" min="0" value="0" class="form-control form-control-sm" placeholder="Vasos"/></div>
            <div class="col-12 d-grid"><button id="btnAddProduct" class="btn btn-primary btn-sm">Agregar Producto</button></div>
          </div>
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm" id="tblProducts">
              <thead class="sticky-top bg-white">
                <tr><th>SKU</th><th>Nombre</th><th>Precio</th><th>POS</th><th>Vasos</th><th>Acciones</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- GestiÃ³n de Empleados -->
      <div class="col-12 col-lg-6">
        <div class="tile">
          <h6>GestiÃ³n de Empleados</h6>
          <div class="row g-2 mb-3">
            <div class="col-6"><input id="empName" class="form-control form-control-sm" placeholder="Nombre completo"/></div>
            <div class="col-6"><input id="empRole" class="form-control form-control-sm" placeholder="Cargo"/></div>
            <div class="col-12"><input id="empSalary" type="number" class="form-control form-control-sm" placeholder="Salario diario"/></div>
            <div class="col-12 d-grid"><button id="btnAddEmployee" class="btn btn-success btn-sm">Agregar Empleado</button></div>
          </div>
          <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-sm" id="tblEmployees">
              <thead class="sticky-top bg-white">
                <tr><th>Nombre</th><th>Cargo</th><th>Salario/dÃ­a</th><th>Estado</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- GestiÃ³n de Socios -->
      <div class="col-12">
        <div class="tile">
          <h6>GestiÃ³n de Socios y Porcentajes</h6>
          <div class="row g-2 mb-3">
            <div class="col-md-4"><input id="partnerName" class="form-control form-control-sm" placeholder="Nombre del socio"/></div>
            <div class="col-md-4"><input id="partnerShare" type="number" min="0" max="100" step="0.1" class="form-control form-control-sm" placeholder="% ParticipaciÃ³n"/></div>
            <div class="col-md-4 d-grid"><button id="btnAddPartner" class="btn btn-primary btn-sm">Agregar Socio</button></div>
          </div>
          <div id="partnersContainer"></div>
        </div>
      </div>
      
      <!-- GestiÃ³n de Encargados por POS -->
      <div class="col-12">
        <div class="tile">
          <h6>Encargados por POS</h6>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Encargado de Barra</label>
              <input id="encargadoBarra" class="form-control form-control-sm" placeholder="Nombre del encargado">
            </div>
            <div class="col-md-6">
              <label class="form-label">Encargado de Granizados</label>
              <input id="encargadoGranizados" class="form-control form-control-sm" placeholder="Nombre del encargado">
            </div>
            <div class="col-12">
              <button id="btnGuardarEncargados" class="btn btn-success btn-sm">Guardar Encargados</button>
            </div>
          </div>
          <div id="encargadosActuales" class="mt-2"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Socios - VERSIÃ“N ACTUALIZADA CON NAVEGACIÃ“N DE CIERRES AVANZADOS -->
  <!-- Socios - Cierres y Repartos -->
  <section id="socios" class="tile mt-3" hidden>
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Cierres + Reparto</h5>
      <button class="btn btn-sm btn-outline-secondary" data-goto="home">Volver</button>
    </div>
    
    <!-- NavegaciÃ³n de cierres -->
    <div class="nav-cierres mt-3">
      <button onclick="mostrarCierre('diario')" class="nav-cierre-btn active">
        ğŸ“Š Cierre Diario
      </button>
      <button onclick="mostrarCierre('semanal')" class="nav-cierre-btn">
        ğŸ“ˆ Cierre Semanal
      </button>
      <button onclick="mostrarCierre('administracion')" class="nav-cierre-btn">
        ğŸ› ï¸ AdministraciÃ³n Avanzada
      </button>
    </div>
    
    <!-- Contenedor Cierre Diario -->
    <div id="cierre-diario-container" class="cierre-container active">
      <div class="row g-2 mt-2">
        <div class="col-12 tile">
          <h6>ğŸ”® Inferir Ventas en Efectivo</h6>
          <div class="d-flex flex-wrap gap-2 mb-3">
            <button onclick="ejecutarInferencia('Barra')" class="btn-inferir">
              âš¡ Inferir Barra
            </button>
            <button onclick="ejecutarInferencia('Granizados')" class="btn-inferir">
              âš¡ Inferir Granizados
            </button>
          </div>
          <div id="resultado-inferencia"></div>
        </div>
        
        <div class="col-12 tile">
          <h6>ğŸ’° Cierre Diario</h6>
          <div class="d-flex flex-wrap gap-2">
            <input type="date" id="fechaDia" class="form-control" style="max-width:200px">
            <button id="btnCierreDia" class="btn btn-dark">Generar</button>
            <div class="vr"></div>
            <input type="number" id="efContadoBarra" class="form-control" placeholder="Efectivo contado Barra" style="max-width:220px">
            <input type="number" id="efContadoGrz" class="form-control" placeholder="Efectivo contado Granizados" style="max-width:260px">
            <button onclick="calcularYRegistrarDescuadres()" class="btn btn-outline-danger">Calcular Descuadres</button>
          </div>
          <div id="cierreDia" class="mt-3"></div>
          <div id="resultado-descuadres" class="mt-2"></div>
        </div>
      </div>
    </div>
    
    <!-- Contenedor Cierre Semanal -->
    <div id="cierre-semanal-container" class="cierre-container">
      <div class="row g-2 mt-2">
        <div class="col-12 tile">
          <h6>ğŸ“ˆ Cierre Semanal + Reparto</h6>
          <div class="d-flex gap-2 mb-3">
            <input type="date" id="semDesde" class="form-control" style="max-width:200px">
            <input type="date" id="semHasta" class="form-control" style="max-width:200px">
            <button onclick="recalcularCierreSemanal()" class="btn btn-dark">Generar</button>
          </div>
          
          <!-- Gastos Semanales Extra -->
          <div class="gastos-extra-form">
            <h6>ğŸ’¸ Gastos Semanales Extra</h6>
            <div class="row g-2">
              <div class="col-md-4">
                <input type="text" id="concepto-extra" class="form-control form-control-sm" placeholder="Concepto (cemento, pintura...)">
              </div>
              <div class="col-md-3">
                <input type="number" id="monto-extra" class="form-control form-control-sm" placeholder="Monto" min="0">
              </div>
              <div class="col-md-3">
                <input type="text" id="atribuido-extra" class="form-control form-control-sm" placeholder="Atribuido a (opcional)">
              </div>
              <div class="col-md-2">
                <button onclick="agregarGastoExtra()" class="btn btn-primary btn-sm w-100">â• Agregar</button>
              </div>
            </div>
            <div id="lista-gastos-extra" class="mt-2"></div>
          </div>
          
          <div class="row g-2">
            <div class="col-12 col-lg-6">
              <div id="metricas-periodo" class="loading">Selecciona un perÃ­odo para ver mÃ©tricas</div>
            </div>
            <div class="col-12 col-lg-6">
              <div id="tabla-reparto" class="loading">El reparto se mostrarÃ¡ despuÃ©s de calcular mÃ©tricas</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Contenedor AdministraciÃ³n -->
    <div id="administracion-container" class="cierre-container">
      <div class="tile mt-2">
        <h6>ğŸ› ï¸ AdministraciÃ³n Avanzada</h6>
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <h6>ğŸ’¸ Deudores</h6>
            <div id="lista-deudores-admin" class="mt-2">
              <button onclick="cargarDeudoresAdmin()" class="btn btn-outline-primary">Cargar Deudores</button>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <h6>ğŸ“Š Reportes</h6>
            <div class="row g-2">
              <div class="col-6">
                <input type="date" id="fecha-inicio-reporte" class="form-control form-control-sm">
              </div>
              <div class="col-6">
                <input type="date" id="fecha-fin-reporte" class="form-control form-control-sm">
              </div>
              <div class="col-12">
                <button onclick="generarReporte()" class="btn btn-info btn-sm w-100">ğŸ“ˆ Generar Reporte</button>
              </div>
            </div>
            <div id="resultados-reporte" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="sticky-footer d-flex justify-content-between align-items-center">
  <div class="small text-muted">InstÃ¡lala como PWA (Agregar a pantalla de inicio). Guarda en Supabase.</div>
  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-secondary" data-goto="home">Inicio</button>
  </div>
</div>

<div id="health" style="position:fixed;right:8px;bottom:8px;font:12px system-ui;background:#111;color:#fff;padding:6px 10px;border-radius:8px;opacity:.9;z-index:9999">Cargandoâ€¦</div>

<!-- Health check simple -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const ok = (t)=>{ const el=document.getElementById('health'); el.textContent=t; el.style.background='#198754'; };
  const bad = (t)=>{ const el=document.getElementById('health'); el.textContent=t; el.style.background='#dc3545'; };
  try{
    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    const { error } = await supabase.from('products').select('id', { count: 'exact', head: true });
    if(error) bad('Supabase: ERROR'); else ok('Supabase: OK');
    setTimeout(()=>document.getElementById('health').remove(), 2500);
  }catch(e){ bad('JS error'); }
</script>
</body>
</html>